# -*- eval: (add-hook 'after-save-hook 'org-babel-tangle 'append 'local) -*-
#+title: Emacs Configuration
#+startup: show2levels

* Early-Init
:PROPERTIES:
:HEADER-ARGS: :tangle early-init.el
:END:
** borg initialization
#+begin_src emacs-lisp
  ;;; early-init.el --- earliest birds               -*- lexical-binding: t -*-

  (setq load-prefer-newer t)

  (add-to-list 'load-path
               (expand-file-name
                "lib/auto-compile"
                (file-name-directory (or load-file-name buffer-file-name))))
  (require 'auto-compile)
  (auto-compile-on-load-mode)
  (auto-compile-on-save-mode)

  (setq package-enable-at-startup nil)

  (with-eval-after-load 'package
    (add-to-list 'package-archives
                 (cons "melpa" "https://melpa.org/packages/")
                 t))


#+end_src


** Personal
#+begin_src emacs-lisp
  (setq gc-cons-threshold most-positive-fixnum)
  (setq gc-cons-percentage 0.6)
  (setq package-enable-at-startup nil)
  (setq package-quickstart nil)

  (setq frame-inhibit-implied-resize t)

  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (setq inhibit-splash-screen t)
  (setq use-file-dialog nil)

  (setenv "LSP_USE_PLISTS" "true")
  (setq lsp-use-plists t)
#+end_src

** END
#+begin_src emacs-lisp
  (provide 'early-init)

  ;; Local Variables:
  ;; no-byte-compile: t
  ;; indent-tabs-mode: nil
  ;; End:
  ;;; early-init.el ends here
#+end_src


* Init
:PROPERTIES:
:HEADER-ARGS: :tangle init.el
:END:

** start
#+begin_src emacs-lisp
  ;;; init.el --- user-init-file                    -*- lexical-binding: t -*-
  ;;; Early birds
#+end_src

** borg
#+begin_src emacs-lisp
  (progn ;     startup
    (defvar before-user-init-time (current-time)
      "Value of `current-time' when Emacs begins loading `user-init-file'.")
    (message "Loading Emacs...done (%.3fs)"
             (float-time (time-subtract before-user-init-time
                                        before-init-time)))
    (setq user-init-file (or load-file-name buffer-file-name))
    (setq user-emacs-directory (file-name-directory user-init-file))
    (message "Loading %s..." user-init-file)
    (when (< emacs-major-version 27)
      (setq package-enable-at-startup nil)
      ;; (package-initialize)
      (load-file (expand-file-name "early-init.el" user-emacs-directory)))
    (setq inhibit-startup-buffer-menu t)
    (setq inhibit-startup-screen t)
    (setq inhibit-startup-echo-area-message "locutus")
    (setq initial-buffer-choice t)
    (setq initial-scratch-message "")
    (when (fboundp 'scroll-bar-mode)
      (scroll-bar-mode 0))
    (when (fboundp 'tool-bar-mode)
      (tool-bar-mode 0))
    (menu-bar-mode 0))

  (eval-and-compile ; `borg'
    (add-to-list 'load-path (expand-file-name "lib/borg" user-emacs-directory))
    (require 'borg)
    (borg-initialize))

  (eval-and-compile ; `use-package'
    (setopt use-package-enable-imenu-support t)
    (setopt use-package-verbose t)
    (require 'use-package))

  (use-package compat)

  (use-package dash
    :config (global-dash-fontify-mode))

  (use-package eieio)

  (use-package auto-compile
    :config
    (setq auto-compile-display-buffer               nil)
    (setq auto-compile-mode-line-counter            t)
    (setq auto-compile-source-recreate-deletes-dest t)
    (setq auto-compile-toggle-deletes-nonlib-dest   t)
    (setq auto-compile-update-autoloads             t))

  (use-package epkg
    :defer t
    :init
    (setq epkg-repository
          (expand-file-name "var/epkgs/" user-emacs-directory))
    (setq epkg-database-connector
          (if (>= emacs-major-version 29) 'sqlite-builtin 'sqlite-module)))

  (use-package custom
    :no-require t
    :config
    (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
    (when (file-exists-p custom-file)
      (load custom-file)))

  (use-package server
    :functions (server-running-p)
    :config (or (server-running-p) (server-mode)))

  (progn ;     startup
    (message "Loading early birds...done (%.3fs)"
             (float-time (time-subtract (current-time)
                                        before-user-init-time))))

  ;;; Long tail

  (use-package diff-hl
    :config
    (setq diff-hl-draw-borders nil)
    (global-diff-hl-mode)
    (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh t))

  (use-package diff-mode
    :defer t
    :config
    (when (>= emacs-major-version 27)
      (set-face-attribute 'diff-refine-changed nil :extend t)
      (set-face-attribute 'diff-refine-removed nil :extend t)
      (set-face-attribute 'diff-refine-added   nil :extend t)))

  (use-package dired
    :defer t
    :config (setq dired-listing-switches "-alh"))

  (use-package eldoc
    :when (version< "25" emacs-version)
    :config (global-eldoc-mode))

  (use-package help
    :defer t
    :config (temp-buffer-resize-mode))

  (progn ;    `isearch'
    (setq isearch-allow-scroll t))

  (use-package lisp-mode
    :config
    (add-hook 'emacs-lisp-mode-hook 'outline-minor-mode)
    (add-hook 'emacs-lisp-mode-hook 'reveal-mode)
    (defun indent-spaces-mode ()
      (setq indent-tabs-mode nil))
    (add-hook 'lisp-interaction-mode-hook 'indent-spaces-mode))


  (use-package magit
    :defer t
    :commands (magit-add-section-hook)
    :config
    (magit-add-section-hook 'magit-status-sections-hook
                            'magit-insert-modules
                            'magit-insert-stashes
                            'append))

  (use-package man
    :defer t
    :config (setq Man-width 80))

  (use-package paren
    :config (show-paren-mode))

  (use-package prog-mode
    :config (global-prettify-symbols-mode)
    (defun indicate-buffer-boundaries-left ()
      (setq indicate-buffer-boundaries 'left))
    (add-hook 'prog-mode-hook 'indicate-buffer-boundaries-left))

  (use-package recentf
    :demand t
    :config (add-to-list 'recentf-exclude "^/\\(?:ssh\\|su\\|sudo\\)?x?:"))

  (use-package savehist
    :config (savehist-mode))

  (use-package saveplace
    :when (version< "25" emacs-version)
    :config (save-place-mode))

  (use-package simple
    :config (column-number-mode))

  (use-package smerge-mode
    :defer t
    :config
    (when (>= emacs-major-version 27)
      (set-face-attribute 'smerge-refined-removed nil :extend t)
      (set-face-attribute 'smerge-refined-added   nil :extend t)))

  (progn ;    `text-mode'
    (add-hook 'text-mode-hook 'indicate-buffer-boundaries-left))

  (use-package tramp
    :defer t
    :config
    (add-to-list 'tramp-default-proxies-alist '(nil "\\`root\\'" "/ssh:%h:"))
    (add-to-list 'tramp-default-proxies-alist '("localhost" nil nil))
    (add-to-list 'tramp-default-proxies-alist
                 (list (regexp-quote (system-name)) nil nil))
    (setq vc-ignore-dir-regexp
          (format "\\(%s\\)\\|\\(%s\\)"
                  vc-ignore-dir-regexp
                  tramp-file-name-regexp)))

  (use-package tramp-sh
    :defer t
    :config (cl-pushnew 'tramp-own-remote-path tramp-remote-path))

  ;;; Tequila worms

  (progn ;     startup
    (message "Loading %s...done (%.3fs)" user-init-file
             (float-time (time-subtract (current-time)
                                        before-user-init-time)))
    (add-hook 'after-init-hook
              (lambda ()
                (message
                 "Loading %s...done (%.3fs) [after-init]" user-init-file
                 (float-time (time-subtract (current-time)
                                            before-user-init-time))))
              t))

  (progn ;     personalize
    (let ((file (expand-file-name (concat (user-real-login-name) ".el")
                                  user-emacs-directory)))
      (when (file-exists-p file)
        (load file))))
#+end_src


** Require
#+begin_src emacs-lisp
  ;; garbage collection
  (setq gc-cons-threshold (* 128 1024 1024))

  ;; ??? Process performance tuning
  (setq read-process-output-max (* 4 1024 1024))
  (setq process-adaptive-read-buffering nil)

  (add-to-list 'load-path (expand-file-name "lisp" user-emacs-directory))
  ;; add you personal config
  ;; (dolist (dir '("lisp"))
  ;;   (push (expand-file-name dir user-emacs-directory) load-path))
  ;; add the subdirectory
  ;; (dolist (dir '("site-lisp" "test-lisp"))
  ;;   (let ((default-directory (expand-file-name dir user-emacs-directory)))
  ;;     (normal-top-level-add-subdirs-to-load-path))) ;;how this work


  ;; Now we only need many require command
  ;; (require 'init-base)

  ;; inside
  (require 'init-ui)
  (require 'init-org)

  ;; outside
  (require 'init-rime)
  (require 'init-rainbow-delimiters)
  (require 'init-which-key)
  (require 'init-yasnippet)
  (require 'init-completion)
  (require 'init-eglot)
  (require 'init-dirvish)
  (require 'init-projectile)
  (require 'init-latex)

  (require 'init-check)
  (require 'init-completion)
  (require 'init-super-save)
  (require 'init-markdown-mode)
  (require 'init-font)
  (require 'init-visual-regexp)
  (require 'init-org-roam)
  (require 'init-indent)
  (require 'init-electric-pair-mode)
  (require 'init-tab-bar)

  (require 'init-csv-mode)
  (require 'init-org-download)
  (require 'init-emmet-mode)
  (require 'init-web-mode)
  (require 'init-org-roam-ui)
  (require 'init-treesit)
  (require 'init-treesit-fold)
  (require 'init-yaml-mode)
  (require 'init-org-fragtog)
  (require 'init-hydra)
  (require 'init-sudo-edit)
  (require 'init-leetcode)
  (require 'init-move-text)
  (require 'init-tag)
  (require 'init-ai)
  (require 'init-ace-window)

  (require 'init-personal)


  (require 'init-test)

#+end_src

** END
#+begin_src emacs-lisp
  (provide 'init)

  ;; Local Variables:
  ;; indent-tabs-mode: nil
  ;; End:
  ;;; init.el ends here

#+end_src
* Lisp
** ui
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-ui.el
:END:
*** base
#+begin_src emacs-lisp
  (setq-local multibyte-syntax-as-symbol nil)
  (save-place-mode 1)
  (setq fill-column 80)
  (setq y-or-n-p-as-yes-or-no t)

  (setq system-time-locale "en_US.utf8")

  (prefer-coding-system       'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (set-language-environment   'utf-8)

  ;; (setq visible-bell t)
  (setq word-wrap-by-category t)
  ;; 减少闪烁
  (modify-frame-parameters nil '((inhibit-double-buffering . nil)))

  ;; display column number in the modeline
  (column-number-mode)

  ;; display line numbers and disable in some mode
  ;; (setq-default display-line-numbers-width 4)
  (global-visual-line-mode t)

  (add-hook 'prog-mode-hook #'(lambda () (display-line-numbers-mode 1)))
  (add-hook 'xml-mode-hook #'(lambda () (display-line-numbers-mode 1)))
  (add-hook 'nxml-mode-hook #'(lambda () (display-line-numbers-mode 1)))
  (add-hook 'toml-mode-hook #'(lambda () (display-line-numbers-mode 1)))
  (add-hook 'csv-mode-hook #'(lambda () (display-line-numbers-mode 1)))

  (setq next-screen-context-lines 2)
  ;;FIXED the problem of pdf rolling problem,value can't larger than 21

  (setq enable-recursive-minibuffers +1)
  (setq cursor-in-non-selected-windows nil)

#+end_src
*** theme
#+begin_src elisp
  (setq modus-vivendi-tinted-palette-overrides
        '(
          (fg-main "gray80")
          (bg-main "#181a26")
          (cursor      "green")        ; 来自 (cursor ... :background "green")

          (bg-region   "#103050")
          ;; (fg-region "gray80")
          
          (comment     "gray50")       ; 来自 font-lock-comment-face
          (constant    "DarkOliveGreen3") ; 来自 font-lock-constant-face
          (keyword     "DeepSkyBlue1") ; 来自 font-lock-keyword-face
          (preprocessor "gold")        ; 来自 font-lock-preprocessor-face
          (string      "burlywood")    ; 来自 font-lock-string-face
          (fnname "goldenrod")
          (type        "CadetBlue1")   ; 来自 font-lock-type-face
          (variable "SeaGreen2")  ; 来自 font-lock-variable-name-face
          (builtin     "LightCoral")   ; 来自 font-lock-builtin-face
          (docstring         "moccasin")     ; ??? 来自 font-lock-doc-face
          
          (err       "red")          ; 来自 error 和 compilation-error
          (warning     "Yellow")       ; 来自 warning
          (info        "LightSkyBlue") ; 来自 compilation-info

          ;; --- deeper-blue: 括号匹配 ---
          (bg-paren-match "dodgerblue1")
          (fg-paren-match "white")
          ))
#+end_src

#+begin_src emacs-lisp
  ;; --- 自动主题切换 (init.el 版本) ---
  (setq my-auto-theme-light-theme 'modus-operandi)
  (setq my-auto-theme-dark-theme 'modus-vivendi-tinted)
  (setq my-auto-theme-day-start 9)  ; 白天开始时间 (7 = 7:00)
  (setq my-auto-theme-day-end 18) ; 白天结束时间 (19 = 19:00)

  ;; 2. 定义一个函数来检查并应用主题
  ;;    (我们把它命名为 'my/...' 来避免和其他插件冲突)
  (defun my/auto-theme-switcher-apply-theme ()
    (interactive)
    "根据时间检查并应用一次主题。"
    (let* (
           ;; 获取当前小时 (0-23)
           (current-hour (nth 2 (decode-time (current-time))))
           
           ;; 决定目标主题
           (target-theme
            (if (and (>= current-hour my-auto-theme-day-start)
                     (< current-hour my-auto-theme-day-end))
                ;; 现在是白天
                my-auto-theme-light-theme
              ;; 现在是夜晚
              my-auto-theme-dark-theme)))
      (load-theme target-theme)
      ;; 仅在目标主题尚未加载时才加载它
      ;; (unless (memq target-theme custom-enabled-themes)
      ;;   (message "AutoTheme: 正在根据时间应用 %s" target-theme)
      ;;   (load-theme target-theme ))
      )) ; 't' 表示不询问用户

  ;; (add-hook 'after-make-frame-functions #'my/auto-theme-switcher-apply-theme)
  (my/auto-theme-switcher-apply-theme)
#+end_src

*** ibuffer
#+begin_src elisp
  (global-set-key (kbd "C-x C-b") 'ibuffer-other-window)
  (setq ibuffer-show-empty-filter-groups t)
  (setq ibuffer-saved-filter-groups
        `(("default"
           ;; ("mail" (or
           ;;          (mode . message-mode)
           ;;          (mode . notmuch-hello-mode)
           ;;          (mode . notmuch-search-mode)
           ;;          (mode . notmuch-message-mode)
           ;;          (mode . notmuch-show-mode)
           ;;          (mode . notmuch-tree-mode)
           ;;          (mode . bbdb-mode)
           ;;          (mode . mail-mode)
           ;;          (mode . mu4e-main-mode)
           ;;          (mode . gnus-group-mode)
           ;;          (mode . gnus-summary-mode)
           ;;          (mode . gnus-article-mode)
           ;;          (name . "^\\..bdb$")))
           ("org" (or
                   (mode . org-agenda-mode)
                   (mode . diary-mode)
                   (name . "^\\*Calendar\\*$")
                   (name . "^diary$")
                   (filename . "Pending/org/")))
           ("dired" (mode . dired-mode))
           ("emacs" (or
                     (name . "^\\*package.*results\\*$")
                     (name . "^\\*Shell.*Output\\*$")
                     (name . "^\\*Compile-Log\\*$")
                     (name . "^\\*Completions\\*$")
                     (name . "^\\*Backtrace\\*$")
                     (name . "^\\*dashboard\\*$")
                     (name . "^\\*Messages\\*$")
                     (name . "^\\*scratch\\*$")
                     (name . "^\\*Appointment Alert\\*$")
                     (name . "^\\*info\\*$")
                     (name . "^\\*Help\\*$")))
           )))
  (defun ct/ibuffer-enable-saved-filter-groups ()
    (ibuffer-switch-to-saved-filter-groups "default"))

  (add-hook 'ibuffer-mode-hook #'ct/ibuffer-enable-saved-filter-groups)
  (setq ibuffer-formats
        '((mark modified read-only locked " "
    	          (name 20 20 :left :elide)
    	          " "
    	          (mode 16 16 :left :elide)
    	          " "
    	          filename-and-process)
    	    (mark " "
    	          (name 16 -1)
    	          " " filename)))
#+end_src

*** code
#+begin_src elisp
  (setq c-default-style "linux")
#+end_src

*** end
#+begin_src elisp
  (provide 'init-ui)
#+end_src

** org
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-org.el
:END:
*** ui
#+BEGIN_SRC emacs-lisp
  (require 'org)

  (setq-default line-spacing .1)
  (setq org-imenu-depth 4
        org-ellipsis nil
        ;; org-ellipsis " ┑"
        org-startup-folded 'show2levels
        org-startup-indented t
        org-hide-leading-stars nil
        org-log-into-drawer t
        org-indent-mode-turns-on-hiding-stars nil
        org-fold-catch-invisible-edits 'smart
        )

  ;; (with-eval-after-load 'org
  ;;   ;; Make verbatim with highlight text background.
  ;;   (add-to-list 'org-emphasis-alist
  ;;                '("=" (:background "#ffee11")))
  ;;   ;; Make deletion (obsolete) text foreground with dark gray.
  ;;   (add-to-list 'org-emphasis-alist
  ;;                '("+" (:foreground "dark gray"
  ;;                                   :strike-through t)))
  ;;   ;; Make code style around with box.
  ;;   (add-to-list 'org-emphasis-alist
  ;;                '("~" (:box (:line-width 2
  ;;                                         :color "grey75"
  ;;                                         :style released-button)))))

  (setq org-use-fast-todo-selection t) ;; C-c C-t KEY
#+END_SRC
*** agenda
#+begin_src emacs-lisp
  (global-set-key (kbd "C-c o a") '(lambda () (interactive (org-agenda nil "a"))))
  ;; (global-set-key (kbd "C-c o a") '(lambda () (interactive) (org-agenda nil "d")))

  (setq org-agenda-span 'week
        org-agenda-window-setup 'reorganize-frame
        org-tags-column 0
        ;; org-agenda-compact-blocks nil
        )

  ;; ui
  (setq org-agenda-block-separator ?─
        org-agenda-time-grid
        '((daily today require-timed)
          (800 1000 1200 1400 1600 1800 2000)
          " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
        org-agenda-current-time-string
        "⭠ now  ────────")


  (setq org-directory "~/Documents/org/")
  (setq org-agenda-files '("~/Documents/org/agenda.org" "~/Documents/org/todo.org"))

  (setq org-agenda-skip-scheduled-if-done nil)
  (setq org-agenda-skip-deadline-if-done nil)
  (setq org-agenda-skip-timestamp-if-done nil)

  ;; ??? what is this
  (setq org-agenda-start-with-log-mode t)

  ;; (setq org-agenda-custom-commands
  ;;       (quote
  ;;        ;; `C-a d` is my main Agenda
  ;;        (("d" "Daily Action List"
  ;;          (

  ;;           (agenda "" ((org-agenda-overriding-header "\nOverdue")
  ;;                       (org-agenda-time-grid nil)
  ;;                       (org-agenda-start-on-weekday nil)
  ;;                       (org-agenda-show-all-dates nil)
  ;;                       (org-agenda-format-date "")  ;; Skip the date
  ;;                       (org-agenda-span 1)
  ;;                       (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
  ;;                       (org-agenda-entry-types '(:deadline :scheduled))
  ;;                       (org-scheduled-past-days 999)
  ;;                       (org-deadline-past-days 999)
  ;;                       (org-deadline-warning-days 0)))
  ;;           (agenda "" ((org-agenda-overriding-header " ") ;; Non-empty string
  ;;                       (org-agenda-span 'day)
  ;;                       (org-agenda-ndays 1)
  ;;                       (org-agenda-sorting-strategy (quote ((agenda time-up priority-down tag-up))))

  ;;                       ;; Do not include scheduled, due or overdue items here
  ;;                       (org-deadline-warning-days 0)
  ;;                       (org-scheduled-past-days 0)
  ;;                       (org-deadline-past-days 0)

  ;;                       (org-agenda-skip-scheduled-if-done t)
  ;;                       (org-agenda-skip-timestamp-if-done t)
  ;;                       (org-agenda-skip-deadline-if-done t)))

  ;;           (agenda "" ((org-agenda-overriding-header "\nNext three days\n")
  ;;                       (org-agenda-start-on-weekday nil)
  ;;                       (org-agenda-start-day "+1d")
  ;;                       (org-agenda-span 3)
  ;;                       (org-deadline-warning-days 0)
  ;;                       (org-agenda-block-separator nil)
  ;;                       (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))))
  ;;           (agenda "" ((org-agenda-overriding-header "\nUpcoming deadlines (+14d)\n")
  ;;                       (org-agenda-time-grid nil)
  ;;                       (org-agenda-start-on-weekday nil)
  ;;                       ;; We don't want to replicate the previous section's
  ;;                       ;; three days, so we start counting from the day after.
  ;;                       (org-agenda-start-day "+3d")
  ;;                       (org-agenda-span 14)
  ;;                       (org-agenda-show-all-dates nil)
  ;;                       (org-agenda-time-grid nil)
  ;;                       (org-deadline-warning-days 0)
  ;;                       (org-agenda-block-separator nil)
  ;;                       (org-agenda-entry-types '(:deadline))
  ;;                       (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))))
  ;;           (tags "+focus"
  ;;                 (
  ;;                  (org-tags-match-list-sublevels nil)
  ;;                  (org-agenda-todo-ignore-scheduled 'future)))
  ;;           )))))


  ;; (setq org-agenda-custom-commands
  ;;       '(("A" "Agenda and All todos"
  ;;          ((agenda "" ((org-agenda-span 'week)))
  ;;           (alltodo "")))
  ;;         ))


  ;; (defun ct/display-buffer-org-agenda-managed-p (buffer-name action)
  ;;   "Determine whether BUFFER-NAME is an org-agenda managed buffer."
  ;;   (with-current-buffer buffer-name
  ;;     (and (derived-mode-p 'org-mode)
  ;;          (member (buffer-file-name) (org-agenda-files)))))

  ;; (add-to-list 'display-buffer-alist
  ;;              `("\\*Org Agenda\\*"
  ;;                (display-buffer-in-tab display-buffer-reuse-mode-window)
  ;;                (ignore-current-tab . t)
  ;;                (tab-name . "Org Files")
  ;;                (window-width . ,ct/org-agenda-width)
  ;;                (dedicated . side)  ;; Make the Agenda a dedicated side-window
  ;;                (side . left)       ;; to the left so it always stays open.
  ;;                (inhibit-same-window . nil)))
  ;; (add-to-list 'display-buffer-alist
  ;;              '(ct/display-buffer-org-agenda-managed-p
  ;;                (display-buffer-reuse-mode-window  ;; Prioritize reuse of current window
  ;;                 display-buffer-in-tab)            ;; over switching to the Org tab.
  ;;                ;; (ignore-current-tab . t)
  ;;                (tab-name . "Org Files")))

  ;; (add-hook 'emacs-startup-hook
  ;;           (lambda ()
  ;;             (org-agenda nil "d")))
#+end_src

*** COMMENT capture
set the org capture template
#+begin_src emacs-lisp
  (define-key global-map (kbd "C-c n c") 'org-capture)

  (setq org-capture-templates nil)

  (add-to-list 'org-capture-templates
               '("i" "Inbox" entry (file "~/Documents/roam/inbox.org")
                 "* %^{title} \n %?\n"))

  (add-to-list 'org-capture-templates
               '("t" "Todo" entry (file+headline "~/Documents/org/agenda.org" "GTD")
                 "* TODO %^{title}\n%?"))

  (add-to-list 'org-capture-templates
               '("m" "Mail" entry (file+headline "~/Documents/org/agenda.org" "GTD")
                 "* TODO %:fromname: %a %?\nDEADLINE: %(org-insert-time-stamp (org-read-date nil t \"+2d\"))"))

  ;; (add-to-list 'org-capture-templates '("b" "Blog"))

  ;; (add-to-list 'org-capture-templates
  ;;              '("bi" "Inbox" entry
  ;;                (file+headline "~/Documents/roam/blog/inbox.org")
  ;;                "* TODO %^{任务名}\n%u\n%a\n"))

  ;; (add-to-list 'org-capture-templates
  ;;              '("d" "Diary" entry
  ;;                 (file+olp+datetree "~/Documents/roam/blog/diary.org")
  ;;                 "* %^{title}\n:PROPERTIES:\n:EXPORT_FILE_NAME: %d_%^{title}\n:END:\n"))
#+end_src

*** babel
only the language set here can be babeled.
#+begin_src emacs-lisp
  (with-eval-after-load 'org
    (org-babel-do-load-languages
     'org-babel-load-languages
     (seq-filter
      (lambda (pair)
        (locate-library (concat "ob-" (symbol-name (car pair)))))
      '((emacs-lisp . t)
        (python . t)
        (shell . t)
        (C . t)
        (javascript . t)
        (go . t)
        (java . t)
        (scheme . t)
        (sqlite . t)
        ))))

  (with-eval-after-load 'org
    (add-to-list 'org-src-lang-modes '("javascript" . js-ts) )
    (add-to-list 'org-src-lang-modes '("cpp" . c++-ts) )
    (add-to-list 'org-src-lang-modes '("C" . c-ts) )
    (add-to-list 'org-src-lang-modes '("sh" . bash-ts) )
    (add-to-list 'org-src-lang-modes '("python" . python-ts) )
    (add-to-list 'org-src-lang-modes '("css" . css-ts))
    (add-to-list 'org-src-lang-modes '("yaml" . yaml-ts))
    (add-to-list 'org-src-lang-modes '("java" . java-ts))
    (add-to-list 'org-src-lang-modes '("json" . json-ts)))

  (with-eval-after-load 'org
    (add-to-list 'org-babel-default-header-args:python
                 '(:results . "output")))

  (setq org-confirm-babel-evaluate nil)

  ;; for python
  (setq org-babel-python-command "python3")


  (add-hook 'org-babel-after-execute
            (lambda ()
              (when (eq major-mode 'org-mode)
                (org-redisplay-inline-images))))
#+end_src

*** appear
#+begin_src emacs-lisp
  (require 'org-appear)

  (setq org-hide-emphasis-markers nil)
  (setq org-appear-autolinks t)
  (setq org-appear-autosubmarkers t)
  (setq org-appear-autoentities t)
  (setq org-appear-autokeywords t)
  (setq org-appear-delay 0.3)

  (add-hook 'org-mode-hook 'org-appear-mode)

#+end_src
*** latex

**** highlight
#+begin_src emacs-lisp
  (setq org-highlight-latex-and-related '(native latex entities)) ;; LaTeX 语法高亮设置
  (setq org-pretty-entities t) ;; LaTeX 代码的 prettify
  (setq org-pretty-entities-include-sub-superscripts nil) ;; 不隐藏 LaTeX 的上下标更容易编辑
#+end_src

**** hotkey

#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'org-cdlatex-mode)

  ;; org-cdlatex-mode 中使用 cdlatex 的自动匹配括号, 并把 $...$ 换成 \( ... \)
  (defun my/insert-inline-parentheses ()
    (interactive)
    (insert "\\( ") ;; 把 "\\(" 和 "\\)" 替换成 "$" 就能实现输入成对 "$" 的功能.
    (save-excursion (insert " \\)" )))

  (defun my/insert-inline-parentheses2 ()
    (interactive)
    (insert "\\(") ;; 把 "\\(" 和 "\\)" 替换成 "$" 就能实现输入成对 "$" 的功能.
    (save-excursion (insert "\\)" )))

  (defun my/insert-square-bra-OCDL ()
    (interactive)
    (insert "\\[ ")
    (save-excursion (insert " \\]" )))

  (defun my/insert-inline-braces ()
    (interactive)
    (insert "\\{ ")
    (save-excursion (insert " \\}" )))

  (define-key org-cdlatex-mode-map (kbd "C-M-9") 'my/insert-inline-parentheses)
  (define-key global-map (kbd "C-M-(") 'my/insert-inline-parentheses2)
  (define-key org-cdlatex-mode-map (kbd "C-M-[") 'my/insert-square-bra-OCDL)
  (define-key org-cdlatex-mode-map (kbd "C-M-{") 'my/insert-inline-braces)
#+end_src

**** preview
#+begin_src emacs-lisp
  ;; preview with C-c C-x C-l

  (setq my/latex-preview-scale 1.8) ;; 一般来说这里的 scale 约等于 set-face-attribute 中的 :height /100
  (setq org-format-latex-options
        `(:foreground default :background default :scale ,my/latex-preview-scale :html-foreground "Black" :html-background "Transparent" :html-scale ,my/latex-preview-scale :matchers ("begin" "$1" "$" "$$" "\\(" "\\["))) ;; 增大公式预览的图片大小
#+end_src

*** END

#+begin_src emacs-lisp
  (provide 'init-org)
#+end_src

** emacs rime
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-rime.el
:END:
#+begin_src emacs-lisp
  (require 'rime)

  ;; (setq rime-posframe-properties
  ;;       (list :background-color "#333333"
  ;;   	  :foreground-color "#dcdcdc"
  ;;   	  :internal-border-width 5))

  (setq rime-user-data-dir "~/.config/rime-zrm/")
  (setq default-input-method "rime")

  ;; (setq default-input-method "rime"
  ;;       rime-show-candidate 'posframe)
  ;; (setq rime-posframe-style 'vertical)

  (provide 'init-rime)
#+end_src

** rainbow delimiters
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-rainbow-delimiters.el
:END:
#+begin_src emacs-lisp
  (require 'rainbow-delimiters)

  (add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
  ;; (add-hook 'java-mode-hook #'rainbow-delimiters-mode)

  (provide 'init-rainbow-delimiters)
#+end_src

** which key
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-which-key.el
:END:
#+begin_src emacs-lisp
  (require 'which-key)
  (require 'which-key-posframe)

  (which-key-mode)
  (which-key-posframe-mode)

  (provide 'init-which-key)
#+end_src

** yasnippet
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-yasnippet.el
:END:
#+begin_src emacs-lisp
  (require 'yasnippet)

  (yas-global-mode 1)

  (provide 'init-yasnippet)
#+end_src

** eglot
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-eglot.el
:END:
#+begin_src elisp
  (require 'eglot)

  (with-eval-after-load 'eglot
    ;; Start Eglot automatically in Python, C++, and Rust buffers
    (add-hook 'prog-mode-hook 'eglot-ensure)
    ;; (add-hook 'python-ts-mode 'eglot-ensure)
    ;; (add-hook 'python-mode 'eglot-ensure)
    )

  (with-eval-after-load 'eglot
    (setq eglot-autoshutdown t
          eglot-send-changes-idle-time 0.5)
    (setf (plist-get eglot-events-buffer-config :size) 0)
    )

  (with-eval-after-load 'eglot
    (add-to-list 'eglot-server-programs
                 '(c++-mode . ("clangd" "--header-insertion=never")))
    ;; (add-to-list 'eglot-server-programs
    ;;              '(c++-ts-mode . ("clangd" "--header-insertion=never")))
    (add-to-list 'eglot-server-programs
                 '(c-mode . ("clangd" "--header-insertion=never")))
    ;; (add-to-list 'eglot-server-programs
    ;;              '(c-ts-mode . ("clangd" "--header-insertion=never")))
    (add-to-list 'eglot-server-programs
                 '(python-mode . ("pyright-langserver")) t)
    (add-to-list 'eglot-server-programs
                 '(python-ts-mode . ("pyright-langserver")) t)
    (add-to-list 'eglot-server-programs
                 '(java-mode . ("/home/kazure/.emacs.d/.cache/lsp/eclipse.jdt.ls/bin/jdtls")))
    (add-to-list 'eglot-server-programs
                 '(java-ts-mode . ("/home/kazure/.emacs.d/.cache/lsp/eclipse.jdt.ls/bin/jdtls")))
    (add-to-list 'eglot-server-programs
                 '(scheme-mode . ("racket" "-l" "racket-langserver")))
    (add-to-list 'eglot-server-programs
                 '(asm-mode . ("asm-lsp")))
    (add-to-list 'eglot-server-programs
                 '(emacs-lisp-mode . ("ellsp")))
    )

  (setq eglot-ignored-server-capabilities
        '(:documentOnTypeFormattingProvider
          :documentFormattingProvider
          :documentRangeFormattingProvider
          :renameProvider
          :documentHighlightProvider
          :foldingRangeProvider
          :inlayHintProvider
          :hoverProvider
          ))

  ;; ;; use .eglot-root as project root
  ;; (defun rc/find-root-for-eglot-for-clj
  ;;     (di)r
  ;;   (when (bound-and-true-p eglot-lsp-context)
  ;;     (let ((root (locate-dominating-file dir ".eglot-root")))
  ;; 	  (when root (cons 'transient root)))))
  ;; (add-hook 'project-find-functions #'rc/find-root-for-eglot-for-clj)

  (provide 'init-eglot)
#+end_src

** dirvish
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-dirvish.el
:END:
#+begin_src emacs-lisp
  (require 'dirvish)
  (add-to-list 'load-path "~/.emacs.d/lib/dirvish/extensions/")
  (dirvish-override-dired-mode)
  (define-key global-map (kbd "C-x d") 'dirvish)
  (define-key dired-mode-map (kbd "b") 'dired-up-directory)

  (setq dirvish-mode-line-format
        '(:left (sort symlink) :right (omit yank index)))
  (setq dirvish-attributes           ; The order *MATTERS* for some attributes
        '(vc-state subtree-state nerd-icons collapse git-msg file-time file-size)
        dirvish-side-attributes
        '(vc-state nerd-icons collapse file-size))
  ;; open large directory (over 20000 files) asynchronously with `fd' command
  (setq dirvish-large-directory-threshold 20000)

  (provide 'init-dirvish)
#+end_src

** projectile
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-projectile.el
:END:
#+begin_src emacs-lisp
  (require 'projectile)

  (projectile-mode +1)
  ;; Recommended keymap prefix on Windows/Linux
  (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)

  (provide 'init-projectile)
#+end_src

** LaTex
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-latex.el
:END:
*** auctex
#+begin_src emacs-lisp
  (require 'auctex)

  (setq TeX-auto-save t)
  (setq TeX-parse-self t)
  (setq-default TeX-master t)
#+end_src
*** prettify-symbols-mode
#+begin_src emacs-lisp
  (add-hook 'latex-mode-hook 'prettify-symbols-mode)

  ;; use C-c C-p C-p to preview
  (add-hook 'latex-mode-hook
            (defun preview-larger-previews ()
              (setq preview-scale-function
                    (lambda () (* 1.25
                             (funcall (preview-scale-from-face)))))))

  (setq prettify-symbols-unprettify-at-point t)
#+end_src
*** Tex-fold-mode
#+begin_src emacs-lisp
  (setq TeX-fold-section t)
  (setq TeX-fold-comment t)

  (add-hook 'latex-mode-hook 'TeX-fold-mode)
#+end_src

*** cdlatex

#+begin_src emacs-lisp
  (require 'cdlatex)

  (add-hook 'latex-mode-hook 'turn-on-cdlatex)
#+end_src
*** yasnippet

[[https://karthinks.com/software/latex-input-for-impatient-scholars/][Crazy auto cdlatex]]

#+begin_src emacs-lisp
  (defun my/yas-try-expanding-auto-snippets ()
    (when (and (boundp 'yas-minor-mode)
  	     yas-minor-mode)
      (let ((yas-buffer-local-condition ''(require-snippet-condition . auto)))
        (yas-expand))))

  ;; Try after every insertion
  (add-hook 'post-self-insert-hook #'my/yas-try-expanding-auto-snippets)
#+end_src
*** Calc
#+begin_src emacs-lisp

  (eval-after-load 'latex
    '(progn
       (define-key LaTeX-mode-map (kbd "C-S-e") 'latex-math-from-calc)))
  (eval-after-load 'org
    '(progn
       (define-key org-mode-map (kbd "C-S-e") 'latex-math-from-calc)))

  (defun latex-math-from-calc ()
    "Evaluate `calc' on the contents of line at point."
    (interactive)
    (cond ((region-active-p)
           (let* ((beg (region-beginning))
                  (end (region-end))
                  (string (buffer-substring-no-properties beg end)))
             (kill-region beg end)
             (insert (calc-eval `(,string calc-language latex
                                          calc-prefer-frac t
                                          calc-angle-mode rad)))))
          (t (let ((l (thing-at-point 'line)))
               (end-of-line 1) (kill-line 0)
               (insert (calc-eval `(,l
                                    calc-language latex
                                    calc-prefer-frac t
                                    calc-angle-mode rad)))))))
#+end_src
*** table
#+begin_src emacs-lisp
  (require 'org-table)
  (require 'cdlatex)

  ;; 绑定 orgtbl-mode-map 中的 <tab> 和 TAB 键
  (eval-after-load 'org-table
    '(progn
       (define-key orgtbl-mode-map (kbd "<tab>") #'lazytab-org-table-next-field-maybe)
       (define-key orgtbl-mode-map (kbd "TAB") #'lazytab-org-table-next-field-maybe)))

  ;; 添加 cdlatex-tab-hook
  (add-hook 'cdlatex-tab-hook 'lazytab-cdlatex-or-orgtbl-next-field 90)

  ;; 定义 cdlatex 命令
  (add-to-list 'cdlatex-command-alist '("smat" "Insert smallmatrix env"
                                         "\\left( \\begin{smallmatrix} ? \\end{smallmatrix} \\right)"
                                         #'lazytab-position-cursor-and-edit
                                         nil nil t))
  (add-to-list 'cdlatex-command-alist '("bmat" "Insert bmatrix env"
                                         "\\begin{bmatrix} ? \\end{bmatrix}"
                                         #'lazytab-position-cursor-and-edit
                                         nil nil t))
  (add-to-list 'cdlatex-command-alist '("pmat" "Insert pmatrix env"
                                         "\\begin{pmatrix} ? \\end{pmatrix}"
                                         #'lazytab-position-cursor-and-edit
                                         nil nil t))
  (add-to-list 'cdlatex-command-alist '("tbl" "Insert table"
                                         "\\begin{table}\n\\centering ? \\caption{}\n\\end{table}\n"
                                         #'lazytab-position-cursor-and-edit
                                         nil t nil))

  ;; 定义函数
  (defun lazytab-position-cursor-and-edit ()
    "Positions the cursor after inserting a cdlatex template and calls orgtbl-edit."
    (cdlatex-position-cursor)
    (lazytab-orgtbl-edit))

  (defun lazytab-orgtbl-edit ()
    "Enters org-table mode for editing, and prepares for replacement upon exit."
    (advice-add 'orgtbl-ctrl-c-ctrl-c :after #'lazytab-orgtbl-replace)
    (orgtbl-mode 1)
    (open-line 1)
    (insert "\n|"))

  (defun lazytab-orgtbl-replace (&rest _)
    "Replaces the org-table with its LaTeX/amsmath equivalent."
    (interactive "P")
    (unless (org-at-table-p) (user-error "Not at a table"))
    (let* ((table (org-table-to-lisp))
           params
           (replacement-table
            (if (texmathp)
                (lazytab-orgtbl-to-amsmath table params)
              (orgtbl-to-latex table params))))
      (kill-region (org-table-begin) (org-table-end))
      (open-line 1)
      (push-mark)
      (insert replacement-table)
      (align-regexp (region-beginning) (region-end) "\\([:space:]*\\)& ")
      (orgtbl-mode -1)
      (advice-remove 'orgtbl-ctrl-c-ctrl-c #'lazytab-orgtbl-replace)))

  (defun lazytab-orgtbl-to-amsmath (table params)
    "Converts an org-table to amsmath format."
    (orgtbl-to-generic
     table
     (org-combine-plists
      '(:splice t
        :lstart ""
        :lend " \\\\"
        :sep " & "
        :hline nil
        :llend "")
      params)))

  (defun lazytab-cdlatex-or-orgtbl-next-field ()
    "Moves to the next field in org-table if applicable, otherwise lets cdlatex handle it."
    (when (and (bound-and-true-p orgtbl-mode)
               (org-table-p)
               (looking-at "[[:space:]]*\\(?:|\\|$\\)")
               (let ((s (thing-at-point 'sexp)))
                 (not (and s (assoc s cdlatex-command-alist-comb)))))
      (call-interactively #'org-table-next-field)
      t))

  (defun lazytab-org-table-next-field-maybe ()
    "If cdlatex-mode is active, calls cdlatex-tab, otherwise org-table-next-field."
    (interactive)
    (if (bound-and-true-p cdlatex-mode)
        (cdlatex-tab)
      (org-table-next-field)))
#+end_src

*** reftex
#+begin_src emacs-lisp
  (add-hook 'latex-mode-hook 'turn-on-reftex)
#+end_src

*** pdf
#+begin_src elisp
  (setq TeX-source-correlate-mode t)
  (setq TeX-source-correlate-start-server t)
  (setq TeX-view-program-list '(("Okular" "okular --unique %o#src:%n%b")
                                ))
  (setq TeX-view-program-selection
        (quote
         ((output-pdf "Zathura")
          (output-dvi "Okular")
          (output-html "xdg-open"))))
#+end_src

*** END
#+begin_src emacs-lisp
  (provide 'init-latex)
#+end_src

** markdowm mode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-markdown-mode.el
:END:

#+begin_src emacs-lisp
  (autoload 'markdown-mode "markdown-mode"
     "Major mode for editing Markdown files" t)
  (add-to-list 'auto-mode-alist
               '("\\.\\(?:md\\|markdown\\|mkd\\|mdown\\|mkdn\\|mdwn\\)\\'" . markdown-mode))

  (autoload 'gfm-mode "markdown-mode"
     "Major mode for editing GitHub Flavored Markdown files" t)
  (add-to-list 'auto-mode-alist '("README\\.md\\'" . gfm-mode))

  (with-eval-after-load 'markdown-mode
    (define-key markdown-mode-map (kbd "C-c C-e") #'markdown-do))

  (provide 'init-markdown-mode)
#+end_src

** font
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-font.el
:END:

#+begin_src emacs-lisp
    ;; Set the default font for the Emacs frame.
    ;; This will be your primary monospace font for English text and code.
    ;; Adjust the size as needed.
    (setq initial-frame-alist
          (append (list (cons 'font "Maple Mono NF-12"))
                  initial-frame-alist))
    (setq default-frame-alist
          (append (list (cons 'font "Maple Mono NF-12"))
                  default-frame-alist))

    ;; Optionally, set the font immediately if Emacs is already running with a GUI
    (when (display-graphic-p)
      (set-frame-font "Maple Mono NF-12" t t))

    ;; --- CJK Font Fallback using Fontsets ---
    ;; This is crucial for Chinese character display.
    ;; Emacs uses fontsets to determine which font to use for specific character ranges.
    ;; We tell Emacs to use a specific Chinese font for CJK character sets.

    (when (display-graphic-p)
      (dolist (charset '(kana han cjk-misc bopomofo))
        (set-fontset-font
         (frame-parameter nil 'font) ; Apply to the default fontset of the current frame
         charset
         (font-spec :family "Dream Han Serif CN-extrabold" :size 13) ; Your chosen Chinese font
         nil 'prepend))) ; 'prepend ensures it takes precedence over general fallbacks

    (provide 'init-font)
#+end_src

** visual regexp
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-visual-regexp.el
:END:

  #+begin_src emacs-lisp
    (require 'visual-regexp)
    (define-key global-map (kbd "C-c r") 'vr/replace)
    (define-key global-map (kbd "C-c q") 'vr/query-replace)
    (provide 'init-visual-regexp)
#+end_src

** org roam
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-org-roam.el
:END:

*** basic
#+begin_src emacs-lisp
  (require 'org-roam)

  (add-to-list 'load-path "~/.emacs.d/lib/org-roam/extensions/")
  (require 'org-roam-dailies)
  (require 'org-roam-export)
  (require 'org-roam-graph)
  (require 'org-roam-overlay)
  (require 'org-roam-protocol)

  (setq org-roam-directory (file-truename "~/Documents/roam/"))
  (setq org-roam-db-gc-threshold most-positive-fixnum)
  (setq org-roam-complete-everywhere t)

  (define-key global-map (kbd "C-c n l") 'org-roam-buffer-toggle)
  (define-key global-map (kbd "C-c n f") 'org-roam-node-find)
  (define-key global-map (kbd "C-c n g") 'org-roam-graph)
  (define-key global-map (kbd "C-c n i") 'org-roam-node-insert)
  ;; (define-key global-map (kbd "C-c n c") 'org-roam-capture)
  (define-key global-map (kbd "C-c n d") 'org-roam-dailies-map)
  (define-key global-map (kbd "C-c n h") 'org-id-get-create)
  (define-key global-map (kbd "C-c n j") 'org-roam-dailies-capture-today)

  (org-roam-db-autosync-mode 1)
#+end_src

*** ui
#+begin_src emacs-lisp
  (cl-defmethod org-roam-node-type ((node org-roam-node))
    "Return the TYPE of NODE."
    (condition-case nil
        (file-name-nondirectory
         (directory-file-name
          (file-name-directory
           (file-relative-name (org-roam-node-file node) org-roam-directory))))
      (error "")))

  (setq org-roam-node-display-template
        (concat "${type:15} ${title:*} " (propertize "${tags:20}" 'face 'org-tag)))
#+end_src


*** template

#+begin_src emacs-lisp
  (defun jethro/tag-new-node-as-draft ()
    (org-roam-tag-add '("draft")))
  (add-hook 'org-roam-capture-new-node-hook #'jethro/tag-new-node-as-draft)


  (setq org-roam-capture-templates
        '(
          ;; ("g" "Game" plain "%?"
          ;;  :if-new (file+head "game/%<%Y%m%d%H%M%S>-${slug}.org"
          ;;                     "#+title: ${title}\n#+filetags:\n")`
  	    ;;  :immediate-finish t
  	    ;;  :unnarrowed t)
          ("m" "Main" plain  "%?"
           :if-new
           (file+head "main/${slug}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("r" "Reference" plain "%?"
           :if-new
           (file+head "reference/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("a" "Article" plain "%?"
           :if-new
           (file+head "article/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: :article:\n")
           :immediate-finish t
           :unnarrowed t)
          ("c" "Coding" plain "%?"
           :if-new
           (file+head "coding/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("i" "Idea" plain "%?"
           :if-new
           (file+head "idea/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("R" "Reading" plain "%?"
           :if-new
           (file+head "reading/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("w" "Web" plain "%?"
           :if-new
           (file+head "web/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("s" "Stem" plain "%?"
           :if-new
           (file+head "stem/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)
          ("b" "Blog" plain "%?"
           :if-new
           (file+head "blog/inbox/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: \n")
           :immediate-finish t
           :unnarrowed t)     
          ("p" "Personality" plain "%?"
           :if-new
           (file+head "psychology/${title}.org"
                      "#+TITLE: ${title}\n#+DATE: %<%Y-%m-%d %a>\n#+FILETAGS: :Psych: \n")
           :immediate-finish t
           :unnarrowed t)
          ))

  (setq org-roam-dailies-capture-templates
        '(("d" "default" entry "* %<%I:%M %p>: %?" 
           :if-new (file+head "%<%Y-%m-%d>.org" "#+title: %<%Y-%m-%d>\n#+filetags: :diary:draft:\n\n* Main\n"))))
#+end_src


*** agenda

#+begin_src emacs-lisp
  (defun vulpea-todo-p ()
    "Return non-nil if current buffer has any todo entry.
    TODO entries marked as done are ignored, meaning the this
    function returns nil if current buffer contains only completed
    tasks."
    (seq-find                                 ; (3)
     (lambda (type)
       (eq type 'todo))
     (org-element-map                         ; (2)
         (org-element-parse-buffer 'headline) ; (1)
         'headline
       (lambda (h)
         (org-element-property :todo-type h)))))

  (defun vulpea-todo-update-tag ()
    "Update TODO tag in the current buffer."
    (when (and (not (active-minibuffer-window))
               (vulpea-buffer-p))
      (save-excursion
        (goto-char (point-min))
        (let* ((tags (vulpea-buffer-tags-get))
               (original-tags tags))
          (if (vulpea-todo-p)
              (setq tags (cons "todo" tags))
            (setq tags (remove "todo" tags)))

          ;; cleanup duplicates
          (setq tags (seq-uniq tags))

          ;; update tags if changed
          (when (or (seq-difference tags original-tags)
                    (seq-difference original-tags tags))
            (apply #'vulpea-buffer-tags-set tags))))))

  (defun vulpea-buffer-p ()
    "Return non-nil if the currently visited buffer is a note."
    (and buffer-file-name
         (string-prefix-p
          (expand-file-name (file-name-as-directory org-roam-directory))
          (file-name-directory buffer-file-name))))

  (defun vulpea-todo-files ()
    "Return a list of note files containing 'todo' tag." ;
    (seq-uniq
     (seq-map
      #'car
      (org-roam-db-query
       [:select [nodes:file]
                :from tags
                :left-join nodes
                :on (= tags:node-id nodes:id)
                :where (like tag (quote "%\"todo\"%"))]))))


  (defun vulpea-agenda-files-update (&rest _)
    "Update `org-agenda-files' by merging with current files.
    This function accepts any number of arguments, as required by advice."
    (let ((custom-agenda-files '("~/Documents/org/agenda.org")))
      (setq org-agenda-files
            (seq-uniq
             (append custom-agenda-files
                     (vulpea-todo-files))))))

  (add-hook 'find-file-hook #'vulpea-todo-update-tag)
  (add-hook 'before-save-hook #'vulpea-todo-update-tag)

  (advice-add 'org-agenda :before #'vulpea-agenda-files-update)
  (advice-add 'org-todo-list :before #'vulpea-agenda-files-update)

  ;; functions borrowed from `vulpea' library
  ;; https://github.com/d12frosted/vulpea/blob/6a735c34f1f64e1f70da77989e9ce8da7864e5ff/vulpea-buffer.el

  (defun vulpea-buffer-tags-get ()
    "Return filetags value in current buffer."
    (vulpea-buffer-prop-get-list "filetags" "[ :]"))

  (defun vulpea-buffer-tags-set (&rest tags)
    "Set TAGS in current buffer.
    If filetags value is already set, replace it."
    (if tags
        (vulpea-buffer-prop-set
         "filetags" (concat ":" (string-join tags ":") ":"))
      (vulpea-buffer-prop-remove "filetags")))

  (defun vulpea-buffer-tags-add (tag)
    "Add a TAG to filetags in current buffer."
    (let* ((tags (vulpea-buffer-tags-get))
           (tags (append tags (list tag))))
      (apply #'vulpea-buffer-tags-set tags)))

  (defun vulpea-buffer-tags-remove (tag)
    "Remove a TAG from filetags in current buffer."
    (let* ((tags (vulpea-buffer-tags-get))l
           (tags (delete tag tags)))
      (apply #'vulpea-buffer-tags-set tags)))

  (defun vulpea-buffer-prop-set (name value)
    "Set a file property called NAME to VALUE in buffer file.
    If the property is already set, replace its value."
    (setq name (downcase name))
    (org-with-point-at 1
      (let ((case-fold-search t))
        (if (re-search-forward (concat "^#\\+" name ":\\(.*\\)")
                               (point-max) t)
            (replace-match (concat "#+" name ": " value) 'fixedcase)
          (while (and (not (eobp))
                      (looking-at "^[#:]"))
            (if (save-excursion (end-of-line) (eobp))
                (progn
                  (end-of-line)
                  (insert "\n"))
              (forward-line)
              (beginning-of-line)))
          (insert "#+" name ": " value "\n")))))

  (defun vulpea-buffer-prop-set-list (name values &optional separators)
    "Set a file property called NAME to VALUES in current buffer.
    VALUES are quoted and combined into single string using
    `combine-and-quote-strings'.
    If SEPARATORS is non-nil, it should be a regular expression
    matching text that separates, but is not part of, the substrings.
    If nil it defaults to `split-string-default-separators', normally
    \"[ \f\t\n\r\v]+\", and OMIT-NULLS is forced to t.
    If the property is already set, replace its value."
    (vulpea-buffer-prop-set
     name (combine-and-quote-strings values separators)))

  (defun vulpea-buffer-prop-get (name)
    "Get a buffer property called NAME as a string."
    (org-with-point-at 1
      (when (re-search-forward (concat "^#\\+" name ": \\(.*\\)")
                               (point-max) t)
        (buffer-substring-no-properties
         (match-beginning 1)
         (match-end 1)))))

  (defun vulpea-buffer-prop-get-list (name &optional separators)
    "Get a buffer property NAME as a list using SEPARATORS.
    If SEPARATORS is non-nil, it should be a regular expression
    matching text that separates, but is not part of, the substrings.
    If nil it defaults to `split-string-default-separators', normally
    \"[ \f\t\n\r\v]+\", and OMIT-NULLS is forced to t."
    (let ((value (vulpea-buffer-prop-get name)))
      (when (and value (not (string-empty-p value)))
        (split-string-and-unquote value separators))))

  (defun vulpea-buffer-prop-remove (name)
    "Remove a buffer property called NAME."
    (org-with-point-at 1
      (when (re-search-forward (concat "\\(^#\\+" name ":.*\n?\\)")
                               (point-max) t)
        (replace-match ""))))
#+end_src


*** END
#+begin_src emacs-lisp
  (provide 'init-org-roam)
#+end_src

** org-roam-ui
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-org-roam-ui.el
:END:

#+begin_src emacs-lisp
  (require 'org-roam-ui)
  (require 'websocket)

  ;; (with-eval-after-load 'org-roam
  ;;   (setq org-roam-ui-open-on-start nil
  ;;         org-roam-ui-update-on-save t
  ;;         org-roam-ui-sync-theme t)
  ;;   (org-roam-ui-mode 1))

  (provide 'init-org-roam-ui)
#+end_src


** csv-mode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-csv-mode.el
:END:

#+begin_src emacs-lisp
  (require 'csv-mode)
  (require 'color)

  (defun csv-highlight (&optional separator)
    (interactive (list (when current-prefix-arg (read-char "Separator: "))))
    (font-lock-mode 1)
    (let* ((separator (or separator ?\,))
           (n (count-matches (string separator) (pos-bol) (pos-eol)))
           (colors (cl-loop for i from 0 to 1.0 by (/ 2.0 n)
                            collect (apply #'color-rgb-to-hex
                                           (color-hsl-to-rgb i 0.3 0.5)))))
      (cl-loop for i from 2 to n by 2
               for c in colors
               for r = (format "^\\([^%c\n]+%c\\)\\{%d\\}" separator separator i)
               do (font-lock-add-keywords nil `((,r (1 '(face (:foreground ,c)))))))))

  (add-hook 'csv-mode-hook (lambda () (visual-line-mode -1)))
  (add-hook 'csv-mode-hook 'csv-highlight)
  ;; (add-hook 'csv-mode-hook 'csv-guess-set-separator)
  ;; (add-hook 'csv-mode-hook 'csv-align-mode)
  ;; (add-hook 'csv-mode-hook '(lambda () (interactive) (toggle-truncate-lines nil)))


  (provide 'init-csv-mode)
#+end_src

** org-download
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-org-download.el
:END:

#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'org-download-enable)
  ;; (add-hook 'dired-mode-hook 'org-download-enable)
  (setq-default org-download-method 'directory)
  (setq-default org-download-image-dir "./img")
  (setq-default org-download-heading-lvl 'nil)

  (with-eval-after-load 'org
    (define-key org-mode-map (kbd "C-c d c") 'org-download-clipboard)
    (define-key org-mode-map (kbd "C-c d i") 'org-download-image))

  (provide 'init-org-download)
#+end_src

** emmet-mode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-emmet-mode.el
:END:

#+begin_src emacs-lisp
  (require 'emmet-mode)

  (with-eval-after-load 'emmet-mode
    (define-key emmet-mode-keymap (kbd "M-RET") 'emmet-expand-line))
  
  (add-hook 'sgml-mode-hook 'emmet-mode) ;; Auto-start on any markup modes
  (add-hook 'css-mode-hook  'emmet-mode) ;; enable Emmet's css abbreviation.
  (add-hook 'html-mode-hook  'emmet-mode) ;; enable html
  (add-hook 'js-mode-hook 'emmet-mode)
  ;; (add-to-list 'emmet-jsx-major-modes 'js-mode)
  (add-to-list 'emmet-jsx-major-modes 'js-jsx-mode)
  (add-to-list 'emmet-jsx-major-modes 'js2-jsx-mode)

  ;; (add-hook 'js-ts-mode-hook 'emmet-mode)
  ;; (add-hook 'tsx-ts-mode-hook 'emmet-mode)
  ;; (add-hook 'typescript-ts-mode-hook 'emmet-mode)

  (setq emmet-self-closing-tag-style " /") ;; default "/"
  ;; only " /", "/" and "" are valid.
  ;; eg. <meta />, <meta/>, <meta>

  (setq emmet-move-cursor-after-expanding t) ;; default t
  (setq emmet-move-cursor-between-quotes nil) ;; default nil

  ;; (add-hook 'emmet-mode-hook (lambda () (setq emmet-indentation 2))) ;; indent 2 spaces.
  ;; (add-hook 'emmet-mode-hook (lambda () (setq emmet-indent-after-insert nil)))

  (provide 'init-emmet-mode)
#+end_src

** web-mode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-web-mode.el
:END:

#+begin_src emacs-lisp
  (require 'web-mode)

  (add-to-list 'auto-mode-alist '("\\.phtml\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.tpl\\.php\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.[agj]sp\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.as[cp]x\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.erb\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.mustache\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.djhtml\\'" . web-mode))

  (add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
  ;; (add-to-list 'auto-mode-alist '("\\.css?\\'" . web-mode))

  (provide 'init-web-mode)
#+end_src

** treesit
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-treesit.el
:END:

#+begin_src emacs-lisp
  (require 'treesit)

  (setq treesit-language-source-alist
        '((bash "https://github.com/tree-sitter/tree-sitter-bash")
          (c "https://github.com/tree-sitter/tree-sitter-c")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
          (cmake "https://github.com/uyha/tree-sitter-cmake")
          (csharp "https://github.com/tree-sitter/tree-sitter-c-sharp.git")
          (dockerfile "https://github.com/camdencheek/tree-sitter-dockerfile")
          (elisp "https://github.com/Wilfred/tree-sitter-elisp")
          (elixir "https://github.com/elixir-lang/tree-sitter-elixir")
          (haskell "https://github.com/tree-sitter/tree-sitter-haskell")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (go "https://github.com/tree-sitter/tree-sitter-go")
          (html "https://github.com/tree-sitter/tree-sitter-html")
          (java "https://github.com/tree-sitter/tree-sitter-java.git")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (php . ("https://github.com/tree-sitter/tree-sitter-php"))
          (lua . ("https://github.com/Azganoth/tree-sitter-lua"))
          (make "https://github.com/alemuller/tree-sitter-make")
          (markdown "https://github.com/ikatyang/tree-sitter-markdown")
          (org . ("https://github.com/milisims/tree-sitter-org"))
          (python "https://github.com/tree-sitter/tree-sitter-python")
          (ruby . ("https://github.com/tree-sitter/tree-sitter-ruby"))
          (toml "https://github.com/tree-sitter/tree-sitter-toml")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (rust . ("https://github.com/tree-sitter/tree-sitter-rust"))
          (sql . ("https://github.com/m-novikov/tree-sitter-sql"))
          (vue . ("https://github.com/merico-dev/tree-sitter-vue"))
          (kotlin . ("https://github.com/fwcd/tree-sitter-kotlin"))
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")
          (zig . ("https://github.com/GrayJack/tree-sitter-zig"))
          (clojure . ("https://github.com/sogaiu/tree-sitter-clojure"))
          ))


  (setq major-mode-remap-alist
        '((c-mode . c-ts-mode)
          (c++-mode . c++-ts-mode)
          (clojure-mode . clojure-ts-mode)
          (conf-toml-mode . toml-ts-mode)
          (css-mode . css-ts-mode)
          (go-mode . go-ts-mode)
          (js-mode . js-ts-mode)
          (js2-mode . js-ts-mode)
          (java-mode . java-ts-mode)
          (json-mode . json-ts-mode)
          (js-json-mode . js-ts-mode)
          (python-mode . python-ts-mode)
          (rust-mode . rust-ts-mode)
          (sh-mode . bash-ts-mode)
          (typescript-mode . typescript-ts-mode)
          (toml-mode . toml-ts-mode)
          (yaml-mode . yaml-ts-mode)
          ;; (markdown-mode . markdown-ts-mode)
          ))

  ;; (add-hook 'markdown-ts-mode-hook (lambda () (treesit-parser-create 'markdown)))
  ;; (add-hook 'zig-mode-hook (lambda () (treesit-parser-create 'zig)))
  ;; (add-hook 'mojo-mode-hook (lambda () (treesit-parser-create 'mojo)))
  (add-hook 'emacs-lisp-mode-hook (lambda () (treesit-parser-create 'elisp)))
  (add-hook 'ielm-mode-hook (lambda () (treesit-parser-create 'elisp)))
  ;; (add-hook 'json-mode-hook (lambda () (treesit-parser-create 'json)))
  ;; (add-hook 'go-mode-hook (lambda () (treesit-parser-create 'go)))
  ;; (add-hook 'java-mode-hook (lambda () (treesit-parser-create 'java)))
  ;; (add-hook 'java-ts-mode-hook (lambda () (treesit-parser-create 'java)))
  ;; (add-hook 'clojure-mode-hook (lambda () (treesit-parser-create 'clojure)))
  ;; (add-hook 'clojure-ts-mode-hook (lambda () (treesit-parser-create 'clojure)))
  ;; (add-hook 'cider-repl-mode-hook (lambda () (treesit-parser-create 'clojure)))
  ;; (add-hook 'php-mode-hook (lambda () (treesit-parser-create 'php)))
  ;; (add-hook 'php-ts-mode-hook (lambda () (treesit-parser-create 'php)))
  ;; (add-hook 'haskell-mode-hook (lambda () (treesit-parser-create 'haskell)))
  ;; (add-hook 'kotlin-mode-hook (lambda () (treesit-parser-create 'kotlin)))
  ;; (add-hook 'ruby-mode-hook (lambda () (treesit-parser-create 'ruby)))
  ;; (add-hook 'org-mode-hook (lambda () (treesit-parser-create 'org)))

  (add-hook 'web-mode-hook #'(lambda ()
                               (let ((file-name (buffer-file-name)))
                                 (when file-name
                                   (treesit-parser-create
                                    (pcase (file-name-extension file-name)
                                      ("vue" 'vue)
                                      ("html" 'html)
                                      ("php" 'php))))
                                 )))

  (setq treesit-font-lock-level 4)

  ;; for cmake-ts-mode
  (add-to-list 'auto-mode-alist '("CMakeLists\\.txt\\'" . cmake-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.cmake\\'" . cmake-ts-mode))

  (provide 'init-treesit)
#+end_src

** treesit-fold
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-treesit-fold.el
:END:

#+begin_src emacs-lisp
  (require 'treesit-fold)

  (define-key global-map (kbd "C-c k j") 'treesit-fold-close)
  (define-key global-map (kbd "C-c k J") 'treesit-fold-close-all)
  (define-key global-map (kbd "C-c k l") 'treesit-fold-open)
  (define-key global-map (kbd "C-c k ;") 'treesit-fold-open-recursively)
  (define-key global-map (kbd "C-c k L") 'treesit-fold-open-all)

  (global-treesit-fold-mode 1)
  (global-treesit-fold-indicators-mode 1)
  (setq treesit-fold-line-count-show t)  ; Show line count in folded regions
  ;; (setq treesit-fold-line-count-format " <%d lines> ")
  ;; (add-hook 'org-mode-hook (lambda () (setq treesit-fold-indicators-fringe 'right-fringe)))

  (setq treesit-fold-summary-show t)
  (setq treesit-fold-summary-max-length 60)
  (setq treesit-fold-summary-exceeded-string "...")
  (setq treesit-fold-summary-format " <S> %s ")

  (setq treesit-fold-line-comment-mode t)

  (provide 'init-treesit-fold)
#+end_src

** yaml-mode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-yaml-mode.el
:END:

#+begin_src emacs-lisp
  (require 'yaml-mode)

  (add-to-list 'auto-mode-alist '("\\.yml\\'" . yaml-mode))
  (add-hook 'yaml-mode-hook
            '(lambda ()
               (define-key yaml-mode-map "\C-m" 'newline-and-indent)))

  (provide 'init-yaml-mode)
#+end_src

** org-fragtog
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-org-fragtog.el
:END:

#+begin_src emacs-lisp
  (require 'org-fragtog)

  (add-hook 'org-mode-hook 'org-fragtog-mode)
  (setq org-fragtog-preview-delay 0.2)

  (provide 'init-org-fragtog)
#+end_src

** hydra
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-hydra.el
:END:

*** require
#+begin_src emacs-lisp
  (require 'hydra)
  (require 'major-mode-hydra)
  (require 'pretty-hydra)
  (require 'org-tempo)
  (require 'posframe)
#+end_src
*** hydra-posframe
#+begin_src emacs-lisp
  (defgroup hydra-posframe nil
    "Using posframe to show hydra"
    :group 'hydra
    :prefix "hydra-posframe")

  (defcustom hydra-posframe-parameters nil
    "The frame parameters used by hydra-posframe."
    :type 'string
    :group 'hydra-posframe)

  (defcustom hydra-posframe-border-width 1
    "The border width used by hydra-posframe.
  When 0, no border is showed."
    :group 'hydra-posframe
    :type 'number)

  (defcustom hydra-posframe-poshandler 'posframe-poshandler-frame-center
    "The poshandler used by hydra-posframe."
    :group 'hydra-posframe
    :type 'function)

  (defcustom hydra-posframe-font nil
    "The font used by hydra-posframe.
  When nil, Using current frame's font as fallback."
    :group 'hydra-posframe
    :type 'string)

  (defface hydra-posframe-face
    '((t :inherit default))
    "The background and foreground color of the posframe.
  `background' and `foreground` are used in this face."
    :group 'hydra-posframe)

  (defface hydra-posframe-border-face
    '((t (:background "gray50")))
    "The border color of the posframe.
  Only `background` is used in this face."
    :group 'hydra-posframe)

  (defvar hydra-posframe-buffer " *hydra-posframe-buffer*"
    "The posframe-buffer used by hydra-posframe.")

  (defun hydra-posframe-hide-window ()
    "Hide the hydra posframe"
    (posframe-hide hydra-posframe-buffer))

  (defun hydra-posframe-show-window (str)
    "Show hydra hints on the posframe"
    (posframe-show
     hydra-posframe-buffer
     :font hydra-posframe-font
     :poshandler hydra-posframe-poshandler
     :foreground-color (face-foreground 'hydra-posframe-face nil t)
     :background-color (face-background 'hydra-posframe-face nil t)
     :border-width hydra-posframe-border-width
     :border-color (face-attribute 'hydra-posframe-border-face :background)
     :string (concat str "\n")
     :override-parameters hydra-posframe-parameters)
    (let ((current-frame
           (buffer-local-value 'posframe--frame
                               (get-buffer hydra-posframe-buffer))))
      (redirect-frame-focus current-frame
                            (frame-parent current-frame))))

  ;;;###autoload
  (define-minor-mode hydra-posframe-mode
    "Display hydra via posframe."
    :init-value nil
    :global t
    :require 'hydra-posframe
    :group 'hydra-posframe
    (let ((hydra-posframe-list (list 'hydra-posframe
                                     #'hydra-posframe-show-window
                                     #'hydra-posframe-hide-window)))
      (if hydra-posframe-mode
          (progn
            (add-to-list 'hydra-hint-display-alist hydra-posframe-list)
            (setq hydra-hint-display-type 'hydra-posframe))
        (progn
          (setq hydra-hint-display-alist
                (delete hydra-posframe-list hydra-hint-display-alist))
          (setq hydra-hint-display-type 'lv)))))

  ;;;###autoload
  (defun hydra-posframe-enable ()
    "Enable hydra-posframe."
    (interactive)
    (hydra-posframe-mode 1)
    (message "hydra-posframe: suggest use `hydra-posframe-mode` instead."))

  (hydra-posframe-mode 1)
#+end_src
*** hydra-org
#+begin_src emacs-lisp
  (defun hot-expand (str &optional mod)
    "Expand org template.

  STR is a structure template string recognised by org like <s. MOD is a
  string with additional parameters to add the begin line of the
  structure element. HEADER string includes more parameters that are
  prepended to the element after the #+HEADER: tag."
    (let (text)
      (when (region-active-p)
        (setq text (buffer-substring (region-beginning) (region-end)))
        (delete-region (region-beginning) (region-end)))
      (insert str)
      (if (fboundp 'org-try-structure-completion)
          (org-try-structure-completion) ; < org 9
        (progn
          (org-tempo-complete-tag)))
      (when mod (insert mod) (forward-line))
      (when text (insert text))))

   (pretty-hydra-define org-hydra
    (:color blue :quit-key "C-g" :title "Org Hydra")
    ("Basic"
     (("a" (hot-expand "<a") "ascii")
      ;; ("c" (hot-expand "<c") "center")
      ("C" (hot-expand "<C") "comment")
      ("x" (hot-expand "<e") "example")
      ("E" (hot-expand "<E") "export")
      ("h" (hot-expand "<h") "html")
      ("l" (hot-expand "<l") "latex")
      ;; ("n" (hot-expand "<n") "note")
      ;; ("v" (hot-expand "<v") "verse")
      ("q" (hot-expand "<q") "quote"))

     ;; "Head"
     ;; (("i" (hot-expand "<i") "index")
     ;;  ("A" (hot-expand "<A") "ASCII")
     ;;  ("I" (hot-expand "<I") "INCLUDE")
     ;;  ("H" (hot-expand "<H") "HTML")
     ;;  ("L" (hot-expand "<L") "LaTeX"))
     "Source"
     (("c" (hot-expand "<s" "cpp") "cpp")
      ("s" (hot-expand "<s") "src")
      ("e" (hot-expand "<s" "elisp") "emacs-lisp")
      ("p" (hot-expand "<s" "python :results output") "python")
      ("j" (hot-expand "<s" "javascript") "javascript")
      ("w" (hot-expand "<s" "powershell") "powershell")
      ("r" (hot-expand "<s" "ruby") "ruby")
      ;; ("S" (hot-expand "<s" "sh") "sh")
      ("S" (hot-expand "<s" "scheme :results output") "scheme")
      ("Q" (hot-expand "<s" "sqlite :colnames yes") "sqlite")
      ("g" (hot-expand "<s" "go :imports '\(\"fmt\"\)") "golang"))
     "Misc"
     (
      ;; ("m" (hot-expand "<s" "mermaid :file chart.png") "mermaid")
      ;; ("u" (hot-expand "<s" "plantuml :file ./static/chart.png") "plantuml")
      ("Y" (hot-expand "<s" "ipython :session :exports both :results raw drawer\n$0") "ipython")
      ("P" (progn
            (insert "#+HEADERS: :results output :exports both :shebang \"#!/usr/bin/env perl\"\n")
            (hot-expand "<s" "perl")) "Perl tangled")
      ("<" self-insert-command "ins"))))


  (with-eval-after-load 'org
    ;; 确保 org-hydra/body 在 org-mode-map 中可用
    (define-key org-mode-map (kbd "<")
      (lambda ()
        "Insert org template."
        (interactive)
        (if (or (region-active-p) (looking-back "^\\s-*" 1))
            (org-hydra/body)
          (self-insert-command 1)))))
#+end_src
*** END

#+begin_src emacs-lisp
  (provide 'init-hydra)
#+end_src
** sudo-edit
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-sudo-edit.el
:END:


#+begin_src emacs-lisp
  (require 'sudo-edit)

  (define-key global-map (kbd "C-c o e") 'sudo-edit)

  (provide 'init-sudo-edit)
#+end_src
** leetcode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-leetcode.el
:END:


#+begin_src emacs-lisp
  (require 'leetcode)

  (setq leetcode-prefer-language "cpp")

  ;; (setq leetcode-prefer-sql "mysql")

  (setq leetcode-save-solutions t)
  (setq leetcode-directory "~/Documents/cs_learning/leetcode")

  ;; (setq leetcode-prefer-tag-display nil)

  (global-set-key (kbd "C-c o c") 'leetcode)

  (add-hook 'leetcode--problems-mode-hook
            (lambda () (display-line-numbers-mode -1)))
  (add-hook 'leetcode--problem-detail-mode-hook
            (lambda () (display-line-numbers-mode -1)))

  (provide 'init-leetcode)
#+end_src
** move-text
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-move-text.el
:END:

#+begin_src emacs-lisp
  (require 'move-text)

  (move-text-default-bindings)

  (defun indent-region-advice (&rest ignored)
    (let ((deactivate deactivate-mark))
      (if (region-active-p)
          (indent-region (region-beginning) (region-end))
        (indent-region (line-beginning-position) (line-end-position)))
      (setq deactivate-mark deactivate)))

  (advice-add 'move-text-up :after 'indent-region-advice)
  (advice-add 'move-text-down :after 'indent-region-advice)

  (provide 'init-move-text)
#+end_src
** tag
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-tag.el
:END:

#+begin_src emacs-lisp
  (require 'highlight-matching-tag)
  (require 'instant-rename-tag)

  (with-eval-after-load 'web-mode
    (highlight-matching-tag 1))

  (define-key web-mode-map (kbd "C-M-<return>") 'instant-rename-tag)

  (provide 'init-tag)
#+end_src
** ai
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-ai.el
:END:

#+begin_src emacs-lisp
  (require 'gptel)
  (require 'gptel-magit)
  (global-set-key (kbd "C-c o g") 'gptel)
  ;; (gptel-make-ollama "Ollama"             ;Any name of your choosing
  ;;   :host "localhost:11434"               ;Where it's running
  ;;   :stream t                             ;Stream responses
  ;;   :models '(mistral:latest))          ;List of models

  ;; ;; OPTIONAL configuration
  ;; (setq
  ;;  gptel-model 'mistral:latest
  ;;  gptel-backend (gptel-make-ollama "Ollama"
  ;;                  :host "localhost:11434"
  ;;                  :stream t
  ;;                  :models '(mistral:latest)))


  ;; (gptel-make-deepseek "DeepSeek"       ;Any name you want
  ;; :stream t                           ;for streaming responses
  ;; :key "your-api-key")               ;can be a function that returns the key
  ;; ;; OPTIONAL configuration
  ;; (setq gptel-model   'deepseek-reasoner
  ;;       gptel-backend (gptel-make-deepseek "DeepSeek"
  ;;                       :stream t
  ;;                       :key "your-api-key"))


  ;; (gptel-make-gh-copilot "Copilot")
  ;; OPTIONAL configuration
  (setq gptel-model 'claude-sonnet-4
        gptel-backend (gptel-make-gh-copilot "Copilot"))
  ;; claude-sonnet-4

  (setq-default gptel-default-mode 'org-mode)
  (add-hook 'gptel-mode-hook '(lambda () (org-num-mode -1)) )

  (global-set-key (kbd "C-c a g") 'gptel)
  (global-set-key (kbd "C-c a s") 'gptel-send)
  (global-set-key (kbd "C-c a r") 'gptel-rewrite)
  (global-set-key (kbd "C-c a m") 'gptel-menu)
  (global-set-key (kbd "C-c a a") 'gptel-add-file)
  (global-set-key (kbd "C-c a A") 'gptel-add)
  (global-set-key (kbd "C-c a t") 'gptel-org-set-topic)

  ;; set property under each heading
  ;; :PROPERTIES:
  ;; :gptel-model: gpt-4o
  ;; :gptel-system: You are a helpful assistant.
  ;; :END:

  (setq gptel-directives
        '(
          (default
           . "You are a large language model and a conversation partner. Respond concisely.\n1. When I send a message, immediately check and point out any grammar mistakes or awkward wording.\n2. After feedback, answer my questions or provide your response in advanced, fluent English (above TOEFL 110 or IELTS 8.0 level).\n3. At the end of your response, explain any difficult grammar structures and advanced words you used, using clear English suitable for CET-4 550 level.\n")
          (rewrite
           . "Please rewrite the following words or paragraphs\n1. preserve original length.\n2. maintain original style\n3. correct grammatical errors")
          (super-rewrite
           . "Please rewrite the following words or paragraphs and preserve original length as much as possible. Your rewrite should:\n\n1. **Enhance academic precision** by refining terminology and eliminating ambiguous phrasing\n2. **Strengthen analytical depth** through more sophisticated argumentation, evidence presentation and logical progression between ideas\n3. **Improve technical clarity** by explaining complex concepts more accessibly without sacrificing accuracy\n4. **Adapt stylistic approach** based on content type:\n   - Formal academic tone for research-oriented material\n   - Professional technical style for industry applications\n   - Measured journalistic approach for broader academic dissemination\n5. Finally, point out what you modified")
          (programming
           . "You are a large language model and a careful programmer. Provide code and only code as output without any additional text, prompt or note.")
          (writing
           . "You are a large language model and a writing assistant. Respond concisely.")
          (chat
           . "You are a large language model and a conversation partner. Respond concisely.")))

  ;; (add-hook 'gptel-post-stream-hook 'gptel-auto-scroll)
  (add-hook 'gptel-post-response-functions 'gptel-end-of-response)

  (provide 'init-ai)

#+end_src
** ace-window
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-ace-window.el
:END:

#+begin_src emacs-lisp
  (require 'ace-window)

  (global-set-key (kbd "C-x o") 'ace-window)

  (setq aw-keys '(?1 ?2 ?3 ?4 ?5 ?6 ?7 ?8 ?9 ?0))
  (setq aw-background nil)
  (setq aw-scope 'frame)
  (setq aw-dispatch-always nil)
  (setq aw-minibuffer-flag nil)

  (with-eval-after-load 'ace-window
    (setq aw-dispatch-alist
          '((?d aw-delete-window "Delete Window")
            (?D delete-other-windows "Delete Other Windows") ; select one and delete others
  	      (?s aw-swap-window "Swap Windows")
  	      (?m aw-move-window "Move Window")
  	      (?c aw-copy-window "Copy Window")
  	      (?f aw-flip-window)
            (?j aw-switch-buffer-in-window "Select Buffer") ; change and jump
  	      (?J aw-switch-buffer-other-window "Switch Buffer Other Window") ; change but not jump
  	      (?c aw-split-window-fair "Split Fair Window")
  	      (?v aw-split-window-vert "Split Vert Window")
  	      (?h aw-split-window-horz "Split Horz Window")
  	      (?? aw-show-dispatch-help))))

  ;; (global-set-key (kbd "C-x o") 'ace-window)
  ;; (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l))
  ;; (setq aw-background nil)
  ;; (setq aw-dispatch-always nil)

  ;; (defvar aw-dispatch-alist
  ;;   '((?x aw-delete-window "Delete Window")
  ;; 	(?m aw-swap-window "Swap Windows")
  ;; 	(?M aw-move-window "Move Window")
  ;; 	(?c aw-copy-window "Copy Window")
  ;; 	(?j aw-switch-buffer-in-window "Select Buffer")
  ;; 	(?n aw-flip-window)
  ;; 	(?u aw-switch-buffer-other-window "Switch Buffer Other Window")
  ;; 	(?c aw-split-window-fair "Split Fair Window")
  ;; 	(?v aw-split-window-vert "Split Vert Window")
  ;; 	(?b aw-split-window-horz "Split Horz Window")
  ;; 	(?o delete-other-windows "Delete Other Windows")
  ;; 	(?? aw-show-dispatch-help))
  ;;   "List of actions for `aw-dispatch-default'.")

  (provide 'init-ace-window)
#+end_src
** check
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-check.el
:END:
*** jinx

#+begin_src emacs-lisp
  (require 'jinx)
  (add-hook 'emacs-startup-hook #'global-jinx-mode)
  (add-to-list 'jinx-exclude-regexps '(t "\\cc")) ; 拼写检查忽略中文

  (keymap-global-set "M-$" #'jinx-correct)
  (keymap-global-set "C-M-$" #'jinx-languages)

  (setq jinx-languages "en_GB en_US")
#+end_src
*** flymake
#+begin_src elisp
  (setq flymake-no-changes-timeout nil
        flymake-fringe-indicator-position 'right-fringe
        flymake-margin-indicator-position 'right-margin
        flymake-show-diagnostics-at-end-of-line nil)

#+end_src

*** End
#+begin_src elisp
  (provide 'init-check)
#+end_src
** completion
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-completion.el
:END:
*** orderless

#+begin_src emacs-lisp
  (require 'orderless)

  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles basic partial-completion)))
        orderless-component-separator #'orderless-escapable-split-on-space)

  (setq completion-category-overrides
        '((file (styles basic partial-completion))
          (buffer (styles orderless))
          (command (styles orderless basic))))

#+end_src

*** vertico

#+begin_src elisp
  (require 'vertico)
  (add-to-list 'load-path "~/.emacs.d/lib/vertico/extensions/")
  (require 'vertico-directory)

  (vertico-mode)

  (keymap-set vertico-map "RET" #'vertico-directory-enter)
  (keymap-set vertico-map "DEL" #'vertico-directory-delete-char)
  (keymap-set vertico-map "M-DEL" #'vertico-directory-delete-word)
  (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy)
#+end_src

*** consult 

#+begin_src elisp
  (require 'consult)

  (with-eval-after-load 'consult
    (define-key global-map
                [remap isearch-forward] #'consult-line)
    (define-key global-map
                [remap Info-search] #'consult-info)
    (define-key global-map
                [remap recentf-open-files] #'consult-recent-file))

  (global-set-key (kbd "C-c M-x") 'consult-mode-command)
  (global-set-key (kbd "C-c h") 'consult-history)
  (global-set-key (kbd "C-c K") 'consult-kmacro)
  (global-set-key (kbd "C-c M") 'consult-man)
  (global-set-key (kbd "C-c i") 'consult-info)
  (global-set-key (kbd "C-x M-:") 'consult-complex-command)     ;; orig. repeat-complex-command
  (global-set-key (kbd "C-x b") 'consult-buffer)                ;; orig. switch-to-buffer
  (global-set-key (kbd "C-x 4 b") 'consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
  (global-set-key (kbd "C-x 5 b") 'consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
  (global-set-key (kbd "C-x t b") 'consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
  (global-set-key (kbd "C-x r b") 'consult-bookmark)            ;; orig. bookmark-jump
  (global-set-key (kbd "C-x p b") 'consult-project-buffer)      ;; orig. project-switch-to-buffer
  (global-set-key (kbd "M-#") 'consult-register-load)
  (global-set-key (kbd "M-'") 'consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
  (global-set-key (kbd "C-M-#") 'consult-register)
  (global-set-key (kbd "M-y") 'consult-yank-pop)                ;; orig. yank-pop
  (global-set-key (kbd "M-g e") 'consult-compile-error)
  (global-set-key (kbd "M-g r") 'consult-grep-match)
  (global-set-key (kbd "M-g f") 'consult-flymake)               ;; Alternative: consult-flycheck
  (global-set-key (kbd "M-g g") 'consult-goto-line)             ;; orig. goto-line
  (global-set-key (kbd "M-g M-g") 'consult-goto-line)           ;; orig. goto-line
  (global-set-key (kbd "M-g o") 'consult-outline)               ;; Alternative: consult-org-heading
  (global-set-key (kbd "M-g m") 'consult-mark)
  (global-set-key (kbd "M-g k") 'consult-global-mark)
  (global-set-key (kbd "M-g i") 'consult-imenu)
  (global-set-key (kbd "M-g I") 'consult-imenu-multi)
  (global-set-key (kbd "M-s d") 'consult-find)                  ;; Alternative: consult-fd
  (global-set-key (kbd "M-s c") 'consult-locate)
  (global-set-key (kbd "M-s g") 'consult-grep)
  (global-set-key (kbd "M-s G") 'consult-git-grep)
  (global-set-key (kbd "M-s r") 'consult-ripgrep)
  (global-set-key (kbd "M-s l") 'consult-line)
  (global-set-key (kbd "M-s L") 'consult-line-multi)
  (global-set-key (kbd "M-s k") 'consult-keep-lines)
  (global-set-key (kbd "M-s u") 'consult-focus-lines)
  (global-set-key (kbd "M-s e") 'consult-isearch-history)


  (define-key isearch-mode-map (kbd "M-e") 'consult-isearch-history)         ;; orig. isearch-edit-string
  (define-key isearch-mode-map (kbd "M-s e") 'consult-isearch-history)       ;; orig. isearch-edit-string
  (define-key isearch-mode-map (kbd "M-s l") 'consult-line)                  ;; needed by consult-line to detect isearch
  (define-key isearch-mode-map (kbd "M-s L") 'consult-line-multi)            ;; needed by consult-line to detect isearch

  (define-key minibuffer-mode-map (kbd "M-s") 'consult-history)                 ;; orig. next-matching-history-element
  (define-key minibuffer-mode-map (kbd "M-r") 'consult-history)                ;; orig. previous-matching-history-element

  (add-hook 'completion-list-mode-hook #'consult-preview-at-point-mode)

  (advice-add #'register-preview :override #'consult-register-window)
  (setq register-preview-delay 0.5)

  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  (consult-customize
   consult-theme :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep consult-man
   consult-bookmark consult-recent-file consult-xref
   consult-source-bookmark consult-source-file-register
   consult-source-recent-file consult-source-project-recent-file
   ;; :preview-key "M-."
   :preview-key '(:debounce 0.4 any))

  (setq consult-narrow-key "<") ;; "C-+"

  ;; yasnippet
  (with-eval-after-load 'consult
    (require 'consult-yasnippet)
    (global-set-key (kbd "M-g y") #'consult-yasnippet))
#+end_src

*** embark

#+begin_src elisp
  (require 'embark)
  (require 'embark-consult)

  (global-set-key (kbd "C-.") #'embark-act)
  (global-set-key (kbd "C-;") #'embark-dwim)

  (add-hook 'embark-collect-mode-hook #'consult-preview-at-point-mode)

  ;; ;; which-key for embark
  ;; (with-no-warnings
  ;;   (with-eval-after-load 'which-key
  ;;     (defun embark-which-key-indicator ()
  ;;       "An embark indicator that displays keymaps using which-key.
  ;; The which-key help message will show the type and value of the
  ;; current target followed by an ellipsis if there are further
  ;; targets."
  ;;       (lambda (&optional keymap targets prefix)
  ;;         (if (null keymap)
  ;;             (which-key--hide-popup-ignore-command)
  ;;           (which-key--show-keymap
  ;;            (if (eq (plist-get (car targets) :type) 'embark-become)
  ;;                "Become"
  ;;              (format "Act on %s '%s'%s"
  ;;                      (plist-get (car targets) :type)
  ;;                      (embark--truncate-target (plist-get (car targets) :target))
  ;;                      (if (cdr targets) "…" "")))
  ;;            (if prefix
  ;;                (pcase (lookup-key keymap prefix 'accept-default)
  ;;                  ((and (pred keymapp) km) km)
  ;;                  (_ (key-binding prefix 'accept-default)))
  ;;              keymap)
  ;;            nil nil t (lambda (binding)
  ;;                        (not (string-suffix-p "-argument" (cdr binding))))))))

  ;;     (setq embark-indicators
  ;;           '(embark-which-key-indicator
  ;;             embark-highlight-indicator
  ;;             embark-isearch-highlight-indicator))

  ;;     (defun embark-hide-which-key-indicator (fn &rest args)
  ;;       "Hide the which-key indicator immediately when using the completing-read prompter."
  ;;       (which-key--hide-popup-ignore-command)
  ;;       (let ((embark-indicators
  ;;              (remq #'embark-which-key-indicator embark-indicators)))
  ;;         (apply fn args)))

  ;;     (advice-add #'embark-completing-read-prompter
  ;;                 :around #'embark-hide-which-key-indicator)))
#+end_src

*** corfu

#+begin_src elisp
  (require 'corfu)
  (add-to-list 'load-path "~/.emacs.d/lib/corfu/extensions/")
  ;; (require 'corfu-echo)
  (require 'corfu-history)
  (require 'corfu-indexed)
  ;; (require 'corfu-info)
  (require 'corfu-popupinfo)

  (setq tab-always-indent 'complete)
  (setq completion-cycle-threshold 4)
  (setq text-mode-ispell-word-completion nil)

  (setq corfu-auto t
        corfu-auto-prefix 2
        corfu-count 10
        corfu-cycle t
        corfu-preview-current nil
        corfu-on-exact-match nil
        corfu-auto-delay 0.3
        corfu-popupinfo-delay '(0.4 . 0.2)
        corfu-quit-at-boundary t
        global-corfu-modes '((not erc-mode
                                  circe-mode
                                  help-mode
                                  gud-mode
                                  eat-mode)
                             t))

  ;; (setq corfu-popupinfo-delay '(0.4 . 0.2))

  (setq-default corfu-quit-no-match 'separator)
  (add-hook 'after-init-hook #'global-corfu-mode)

  (with-eval-after-load 'corfu
    (corfu-indexed-mode)
    (corfu-popupinfo-mode)
    (corfu-history-mode))

  (dotimes (i 10)
    (define-key corfu-mode-map
                (kbd (format "M-%s" i))
                (kbd (format "C-%s <tab>" i))))


  ;; nerd-icon for corfu
  (require 'nerd-icons-corfu)
  (with-eval-after-load 'corfu
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src

*** End
#+begin_src elisp
  (provide 'init-completion)
#+end_src
** super-save
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-super-save.el
:END:

#+begin_src emacs-lisp
  (require 'super-save)

  (setq super-save-auto-save-when-idle t)
  (setq auto-save-default nil)
  (setq super-save-silent t)
  (setq super-save-remote-files nil)

  (add-to-list 'super-save-triggers 'ace-window)
  (add-to-list 'super-save-hook-triggers 'find-file-hook)

  (super-save-mode +1)

  (provide 'init-super-save)
#+end_src
* munual clone

** indent
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-indent.el
:END:

#+begin_src emacs-lisp
  (setq-default indent-tabs-mode nil
                tab-width 4)

  (defun adjust-languages-indent (n)
    (setq-local c-basic-offset n)
    
    (setq-local coffee-tab-width n)
    (setq-local javascript-indent-level n)
    (setq-local js-indent-level n)
    (setq-local js2-basic-offset n)

    (setq-local web-mode-attr-indent-offset n)
    (setq-local web-mode-attr-value-indent-offset n)
    (setq-local web-mode-code-indent-offset n)
    (setq-local web-mode-css-indent-offset n)
    (setq-local web-mode-markup-indent-offset n)
    (setq-local web-mode-sql-indent-offset n)

    (setq-local css-indent-offset n)

    (setq-local typescript-indent-level n)
    (setq-local c-ts-mode-indent-offset n)
    )

  (dolist (hook (list
                 ;; 'c-mode-hook
                 ;; 'c++-mode-hook
                 ;; 'c++-ts-mode-hook ;; ???
                 ;; 'c-ts-mode-hook
                 'java-mode-hook
                 'haskell-mode-hook
                 'asm-mode-hook
                 'sh-mode-hook
                 'haskell-cabal-mode-hook
                 'ruby-mode-hook
                 'qml-mode-hook
                 'scss-mode-hook
                 'coffee-mode-hook
                 'rust-mode-hook
                 ))
    (add-hook hook #'(lambda ()
                       (setq indent-tabs-mode nil)
                       (adjust-languages-indent 4)
                       )))

  (dolist (hook (list
                 'web-mode-hook
                 'js-mode-hook
                 ;; 'js-ts-mode-hook
                 'typescript-mode-hook
                 'c-mode-hook
                 'c++-mode-hook
                 ))
    (add-hook hook #'(lambda ()
                       (setq indent-tabs-mode nil)
                       (adjust-languages-indent 2)
                       )))

  (provide 'init-indent)
#+end_src
** electric-pair-mode
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-electric-pair-mode.el
:END:
#+begin_src emacs-lisp
  (setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit)


  (dolist (hook (list
                 'org-mode-hook
                 'text-mode-hook
                 'prog-mode-hook
                 ))
    (add-hook hook #'(lambda ()
                       (electric-pair-mode 1))))

  (provide 'init-electric-pair-mode)
#+end_src
** tab-bar
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-tab-bar.el
:END:
#+begin_src emacs-lisp
  (tab-bar-mode 1)
  (tab-bar-history-mode 1)

  (setq tab-bar-close-button-show nil
        tab-bar-new-button-show nil
        tab-bar-tab-hints t
        tab-bar-auto-width nil
        tab-bar-format '(tab-bar-format-tabs-groups tab-bar-separator))

  (defun tab-bar-tab-name-format-hints (name _tab i)
  	  (if tab-bar-tab-hints (concat (format "»%d«" i) "") name))
  (defun tab-bar-tab-group-format-default (tab _i &optional current-p)
  	(propertize
  	 (concat (funcall tab-bar-tab-group-function tab))
  	 'face (if current-p 'tab-bar-tab-group-current 'tab-bar-tab-group-inactive)))

  (add-to-list 'display-buffer-alist
  			 '("\\*scratch\\*"
  			   (display-buffer-in-tab display-buffer-full-frame)
  			   (tab-group . "[EMACS]")))

  (defun emacs-solo/tab-group-from-project ()
    "Call `tab-group` with the current project name as the group."
    (interactive)
    (when-let* ((proj (project-current))
  			  (name (file-name-nondirectory
  					 (directory-file-name (project-root proj)))))
  	(tab-group (format "[%s]" name))))

  (global-set-key (kbd "C-x t P") #'emacs-solo/tab-group-from-project)


  (defun emacs-solo/tab-switch-to-group ()
    "Prompt for a tab group and switch to its first tab.
  Uses position instead of index field."
    (interactive)
    (let* ((tabs (funcall tab-bar-tabs-function)))
  	(let* ((groups (delete-dups
                      (mapcar (lambda (tab)
  							  (funcall tab-bar-tab-group-function tab))
  							tabs)))
  		   (group (completing-read "Switch to group: " groups nil t)))
  	  (let ((i 1) (found nil))
  		(dolist (tab tabs)
  		  (let ((tab-group (funcall tab-bar-tab-group-function tab)))
  			(when (and (not found)
  					   (string= tab-group group))
  			  (setq found t)
  			  (tab-bar-select-tab i)))
  		  (setq i (1+ i)))))))

  (global-set-key (kbd "C-x t g") #'emacs-solo/tab-switch-to-group)

  (provide 'init-tab-bar)
#+end_src
** eldoc
#+begin_src emacs-lisp
  (dolist (hook (list
                 'ielm-mode-hook
                 'emacs-lisp-mode-hook
                 'lisp-interaction-mode-hook
                 'message-mode-hook
                 'Info-mode-hook
                 'erc-mode-hook
                 'org-mode-hook
                 ))
    (add-hook hook #'(lambda ()
                       (require 'eldoc)
                       (require 'eldoc-extension)
                       (setq eldoc-idle-delay 0.05) ;显示一定的延迟， 避免快速移动时minibuffer频繁闪烁
                       (setq eldoc-argument-case 'eldoc-argument-list) ;高亮函数参数
                       (turn-on-eldoc-mode)
                       )))
#+end_src

* Personal
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-personal.el
:END:

** open file in thunar
#+begin_src emacs-lisp
  (defun my-open-current-dir-in-thunar()
    (interactive)
    (let ((dir (expand-file-name default-directory)))
      (start-process "thunar" nil "thunar" dir)
      (message "open %s in Thunar" dir)))

  (define-key global-map (kbd "C-c o f") 'my-open-current-dir-in-thunar)
#+end_src

** open outer terminal
#+begin_src emacs-lisp
  (defun my-open-current-dir-in-terminal ()
    "Open the current directory in the Alacritty terminal."
    (interactive)
    (let ((dir default-directory))
      ;; Arguments for Alacritty to set the working directory
      (start-process "alacritty-process" nil "alacritty" "--working-directory" dir)
      (message "Opened directory: %s in Alacritty" dir)))

  (global-set-key (kbd "C-c o t") 'my-open-current-dir-in-terminal)
#+end_src

** pixel scroll

#+begin_src emacs-lisp
  (pixel-scroll-precision-mode t)
  (setq scroll-preserve-screen-position 'always)

  (setq scroll-margin 3
        scroll-conservatively 100
        hscroll-margin 5)

  (setq mouse-wheel-scroll-amount '(1 ((shift) . 1)))
  (setq mouse-wheel-progressive-speed nil)
  (setq mouse-wheel-follow-mouse 't)
#+end_src

** IDE
#+begin_src emacs-lisp
  (global-set-key (kbd "C-c c C") 'compile)
  (global-set-key (kbd "C-c c c") 'recompile)
  (global-set-key (kbd "C-c c g") 'gdb)

  (setq gdb-many-windows t)

  (advice-add 'gdb-setup-windows :around (lambda (orig-fun &rest args) (my-gdb-setup-windows)))
  (defun my-gdb-setup-windows ()
    (gdb-get-buffer-create 'gdb-locals-buffer)
    (gdb-get-buffer-create 'gdb-breakpoints-buffer)
    (gdb-get-buffer-create 'gdb-inferior-io-buffer)
    (set-window-dedicated-p (selected-window) nil)
    (switch-to-buffer gud-comint-buffer)
    (delete-other-windows)

    (let* ( (win11 (selected-window))
            (win21 (split-window-below (/ (* (window-height) 5) 6) win11)))
      (let* ( (win22 (split-window-right (/ (* (window-width) 3) 8) win21))
              (win23 (split-window-right (/ (* (window-width) 1) 6) win22)))
        (let* ( (win12 (split-window-right (/ (* (window-width) 3) 8) win11))
                (win13 (split-window-below (/ (* (window-height) 5) 6) win11)))
          (gdb-set-window-buffer (gdb-locals-buffer-name) nil win11)
          (gdb-set-window-buffer (gdb-get-buffer-create 'gdb-stack-buffer) nil win13)
          (set-window-buffer win12 (or (gdb-get-source-buffer) (list-buffers-noselect)))
          )
        (gdb-set-window-buffer (gdb-breakpoints-buffer-name) nil win21)
        (gdb-set-window-buffer (gdb-get-buffer-create 'gdb-inferior-io) nil win22)
        (select-window win11)
        (toggle-truncate-lines)
        (toggle-truncate-lines)
        (select-window win23)
        )
      )
    )

  ;; (setq gud-gdb-enable-debuginfod t)
  ;; https://github.com/emacs-mirror/emacs/blob/emacs-29.1/lisp/progmodes/gdb-mi.el#L4986
  ;; (defun my-gdb-setup-windows ()
  ;;   (gdb-get-buffer-create 'gdb-locals-values-buffer)
  ;;   (gdb-get-buffer-create 'gdb-locals-buffer)
  ;;   (gdb-get-buffer-create 'gdb-stack-buffer)
  ;;   (gdb-get-buffer-create 'gdb-breakpoints-buffer)
  ;;   (set-window-dedicated-p (selected-window) nil)
  ;;   (switch-to-buffer gud-comint-buffer)
  ;;   (delete-other-windows)
  ;;   (let* ((win11 (selected-window))
  ;;          (win31 (split-window nil (/ (* (window-height) 3) 4)))
  ;;          (win21 (split-window nil (/ (window-height) 3))))
  ;;     ;; 1
  ;;     (let* ((win13 (split-window-right nil win11))
  ;;            (win12 (split-window-right (/ (* (window-width) 2) 3) win11)))
  ;;       (gdb-set-window-buffer (gdb-get-buffer-create 'gdb-inferior-io) nil win12)
  ;;       (gdb-set-window-buffer (gdb-locals-buffer-name) nil win13))
  ;;     ;; 2
  ;;     (select-window win21)
  ;;     (set-window-buffer win21 (or (gdb-get-source-buffer) (list-buffers-noselect)))
  ;;     (setq gdb-source-window-list (list (selected-window)))
  ;;     (let* ((win22 (split-window-right nil win21))
  ;;            (win23 (split-window-right (/ (* (window-width) 3) 4) win22)))
  ;;       (gdb-set-window-buffer (gdb-get-buffer-create 'gdb-disassembly-buffer) nil win22)
  ;;       (gdb-set-window-buffer (gdb-get-buffer-create 'gdb-registers-buffer) nil win23))
  ;;     ;; 3
  ;;     (select-window win31)
  ;;     (gdb-set-window-buffer (gdb-stack-buffer-name))
  ;;     (let ((win32 (split-window-right)))
  ;;       (gdb-set-window-buffer (gdb-get-buffer-create 'gdb-memory-buffer) nil win32))
  ;;     ;;
  ;;     (select-window win11)))

#+end_src

#+RESULTS:

** javascript
#+begin_src emacs-lisp
  ;; (add-to-list 'auto-mode-alist '("\\.js\\'\\'" . js-ts-mode))
  ;; (add-to-list 'auto-mode-alist '("\\.jsx\\'\\'" . tsx-ts-mode)) ; 如果有 JSX
  ;; (add-to-list 'auto-mode-alist '("\\.ts\\'\\'" . typescript-ts-mode))
  ;; (add-to-list 'auto-mode-alist '("\\.tsx\\'\\'" . tsx-ts-mode))
#+end_src

** subword-mode
#+begin_src emacs-lisp
  ;; use to handle camel name
  (global-subword-mode 1)
#+end_src


** colorful-mode
#+begin_src elisp
  (require 'colorful-mode)

  (setq global-colorful-mode t
        colorful-use-prefix t
        colorful-only-strings 'only-prog
        css-fontify-colors nil)

  ;; (add-to-list 'global-colorful-modes 'helpful-mode)
#+end_src

** link-hint
#+begin_src emacs-lisp
  (require 'link-hint)
  (setq browse-url-browser-function 'browse-url-firefox)

  (global-set-key (kbd "C-c o l") 'link-hint-open-link)
  (global-set-key (kbd "C-c o L") 'link-hint-copy-link)
#+end_src

** modeline
#+begin_src elisp
  (setq minor-mode-alist nil)
  (setq mode-line-mule-info t)

  ;; (setq-default
  ;;  mode-line-format
  ;;  '(
  ;;    "%e"
  ;;    mode-line-front-space
  ;;    (:eval
  ;;     (format "%s%s"
  ;;             (buffer-name)
  ;;             (if (buffer-modified-p) "*" "")))

  ;;    " "
  ;;    mode-name
  ;;    " "
  ;;    mode-line-position
  ;;    " "
  ;;    vc-mode
  ;;    mode-line-end-spaces
  ;;    ))
#+end_src
** org-id-all-file
#+begin_src elisp
  ;;; org-id-all-headlines.el --- Add IDs to all headlines in a buffer

  ;; This file provides a function to iterate through all headlines
  ;; in an Org-mode buffer and ensure each one has a unique ID.
  ;; It requires the built-in org-id library.

  ;; Make sure the org-id library is loaded.
  (require 'org-id)
  (require 'org-element) ; We need this for the new, more robust approach

  (defun my-org-id-all-headlines ()
    "Add a unique ID to every headline in the current Org-mode buffer.

  This function uses the modern `org-element` API to reliably find every
  headline and call `org-id-get-create` to generate and assign a new ID
  if one does not already exist.

  This function is interactive, which means you can call it with `M-x`
  followed by `my-org-id-all-headlines`."
    (interactive)
    ;; Check if the current major mode is org-mode
    (unless (eq major-mode 'org-mode)
      (error "This command is only for Org-mode buffers."))
    (message "Adding IDs to all headlines...")
    (save-excursion
      (let ((headlines-processed 0))
        ;; Use org-element-map to reliably find and process every headline.
        ;; The first argument `(org-element-parse-buffer)` parses the entire
        ;; buffer into an element tree. The second argument `'headline`
        ;; tells the function to only operate on headline elements.
        (org-element-map (org-element-parse-buffer) 'headline
          (lambda (headline)
            (goto-char (org-element-property :begin headline))
            (org-id-get-create)
            (setq headlines-processed (1+ headlines-processed))))
        (if (= headlines-processed 0)
            (message "Done. No headlines found to process.")
          (message "Done. Processed %d headlines." headlines-processed))))
    ;; Save the buffer to make the changes permanent
    (save-buffer))

  ;; Provide a brief description for discoverability.
  (provide 'org-id-all-headlines)

  ;;; End of file
#+end_src
** exec-path-from-shell
#+begin_src elisp
  (require 'exec-path-from-shell)
  (when (daemonp)
    (exec-path-from-shell-initialize))
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize))
#+end_src

** go-mode
#+begin_src elisp
  (require 'go-mode)
  (autoload 'go-mode "go-mode" nil t)
  (add-to-list 'auto-mode-alist '("\\.go\\'" . go-mode))
#+end_src
** no backup
#+begin_src elisp
  (setq make-backup-files nil)
#+end_src
** blog
#+begin_src elisp
  (require 'ox-publish)

  (setq org-publish-project-alist
          `(("content"
             :base-directory "~/Documents/roam/blog/"
             :base-extension "org"
             :exclude: "ltximg/*"
             :html-head "<link rel=\"stylesheet\" type=\"text/css\" href=\"/style.css\" />"
             :html-preamble
             "<nav id=\"main-nav\">
               <ul>
                 <li><a href=\"/\">Main</a></li>
                 <li><a href=\"/about.html\">About</a></li>
                 <li><a href=\"archives.html\">Articles</a></li>
               </ul>
             </nav>"
             :html-postamble
             "<div id=\"blog-footer\">
             <hr>
             <p>
               Content licensed under 
               <a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc-sa/4.0/\" target=\"_blank\">
                 Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License
               </a>
               <br>
               &copy; 2025 Kazure Zheng. All Rights Reserved.
             </p>
             </div>"
             :recursive t
             :publishing-directory "~/Developments/blog/"
             :with-tags t
             :auto-sitemap t
             :sitemap-filename "sitemap.org"
             :sitemap-title ""
             :publishing-function org-html-publish-to-html)
            ("static"
             :base-directory "~/Documents/roam/blog/"
             :base-extension "js\\|css\\|txt\\|jpg\\|gif\\|png"
             :exclude: "ltximg/*"
             :recursive t
             :publishing-directory  "~/Developments/blog/"
             :publishing-function org-publish-attachment)

            ("blog" :components ("content" "static"))))
#+end_src
** rust-mode
#+begin_src elisp
  (require 'rust-mode)
  (autoload 'rust-mode "rust-mode" nil t)
  (add-to-list 'auto-mode-alist '("\\.rs\\'" . rust-mode))
  (add-hook 'rust-mode-hook #'lsp)
#+end_src
** geiser
#+begin_src elisp
  (require 'geiser)
  (require 'geiser-racket)
  (add-hook 'scheme-mode-hook 'geiser-mode)
  (setq geiser-default-implementation 'racket)
#+end_src
** eat
#+begin_src elisp
  (require 'eat)
  (define-key global-map (kbd "C-c c t") 'eat)
#+end_src
** multiple-cursor
#+begin_src elisp
  (require 'multiple-cursors)

  (define-key global-map (kbd "C-c m l") 'mc/edit-lines)
  (define-key global-map (kbd "C-c m e") 'mc/edit-ends-of-lines)
  (define-key global-map (kbd "C-c m a") 'mc/edit-beginnings-of-lines)
  ;; (mc/mark-all-like-this)
  ;; (mc/mark-all-words-like-this)
  ;; (mc/mark-all-symbols-like-this)
  ;; (mc/mark-all-in-region)
  ;; (mc/mark-all-like-this-in-defun)
  ;; (mc/mark-all-words-like-this-in-defun)
  ;; (mc/mark-all-symbols-like-this-in-defun)
  ;; (mc/mark-all-dwim)

  ;; (mc/mark-next-like-this)
  ;; (mc/mark-next-like-this-word)
  ;; (mc/mark-next-word-like-this)
  ;; (mc/mark-next-like-this-symbol)
  ;; (mc/mark-next-symbol-like-this)

  ;; (mc/mark-previous-like-this)
  ;; (mc/mark-previous-like-this-word)
  ;; (mc/mark-previous-word-like-this)
  ;; (mc/mark-previous-like-this-symbol)
  ;; (mc/mark-previous-symbol-like-this)

  ;; (mc/mark-more-like-this-extended)
  ;; (mc/add-cursor-on-click)
  ;; (mc/mark-pop)

  ;; (mc/unmark-next-like-this)
  ;; (mc/unmark-previous-like-this)
  ;; (mc/skip-to-next-like-this)
  ;; (mc/skip-to-previous-like-this)

  ;; (set-rectangular-region-anchor)
  ;; (mc/mark-sgml-tag-pair)
  ;; (mc/insert-numbers)
  ;; (mc/insert-letters)
  ;; (mc/reverse-regions)
  ;; (mc/vertical-align)
  ;; (mc/vertical-align-with-space)
#+end_src
** marginalia
#+begin_src elisp
  (require 'marginalia)
  (require 'nerd-icons-completion)
  (add-hook 'after-init-hook 'marginalia-mode)
  (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup)
  (nerd-icons-completion-mode)

  (setq marginalia-align 'right
        marginalia-field-width 1000)
#+end_src
** breadcrumb
#+begin_src elisp
  (require 'breadcrumb)
  (breadcrumb-mode 1)
#+end_src
** symbol-overlay
#+begin_src elisp
  (require 'symbol-overlay)
  (global-set-key (kbd "M-i") 'symbol-overlay-put)
  (global-set-key (kbd "M-n") 'symbol-overlay-switch-forward)
  (global-set-key (kbd "M-p") 'symbol-overlay-switch-backward)
  (global-set-key (kbd "C-c o s") 'symbol-overlay-mode)
  (global-set-key (kbd "C-c o S") 'symbol-overlay-remove-all)
#+end_src
** expand-region
#+begin_src elisp
  (require 'expand-region)
  (global-set-key (kbd "C-=") 'er/expand-region)

  ;; er/mark-word
  ;; er/mark-symbol
  ;; er/mark-method-call
  ;; er/mark-inside-quotes
  ;; er/mark-outside-quotes
  ;; er/mark-inside-pairs
  ;; er/mark-outside-pairs
#+end_src
** helpful
#+begin_src elisp
  (require 'helpful)

  ;; Note that the built-in `describe-function' includes both functions
  ;; and macros. `helpful-function' is functions only, so we provide
  ;; `helpful-callable' as a drop-in replacement.
  (global-set-key (kbd "C-h f") #'helpful-callable)

  (global-set-key (kbd "C-h v") #'helpful-variable)
  (global-set-key (kbd "C-h k") #'helpful-key)
  (global-set-key (kbd "C-h x") #'helpful-command)

  ;; Lookup the current symbol at point. C-c C-d is a common keybinding
  ;; for this in lisp modes.
  (global-set-key (kbd "C-c C-d") #'helpful-at-point)

  ;; Look up *F*unctions (excludes macros).
  ;;
  ;; By default, C-h F is bound to `Info-goto-emacs-command-node'. Helpful
  ;; already links to the manual, if a function is referenced there.
  (global-set-key (kbd "C-h F") #'helpful-function)

  (setq counsel-describe-function-function #'helpful-callable)
  (setq counsel-describe-variable-function #'helpful-variable)
#+end_src
** anki-helper
#+begin_src elisp
  (require 'anki-helper)
  (setq anki-helper-cloze-use-emphasis 'bold)

  (define-key org-mode-map (kbd "C-c n a s") 'anki-helper-entry-sync-all)
  (define-key org-mode-map (kbd "C-c n a u") 'anki-helper-entry-update-all)
  (define-key org-mode-map (kbd "C-c n a d") 'anki-helper-entry-delete)
  (define-key org-mode-map (kbd "C-c n a b") 'anki-helper-entry-browse)
#+end_src
** gt
#+begin_src elisp
  (require 'gt)
  (setq gt-langs '(en zh))
  (setq gt-default-translator (gt-translator :engines (gt-google-engine)
                                             :render (list
                                                      (gt-posframe-pop-render :if 'word)
                                                      (gt-buffer-render))))
  (define-key global-map (kbd "C-c l") 'gt-translate)
#+end_src
** borg
#+begin_src elisp
  (global-set-key (kbd "C-c o b d") 'epkg-describe-package)
  (global-set-key (kbd "C-c o b a") 'borg-assimilate)
  (global-set-key (kbd "C-c o b b") 'borg-build)
  (global-set-key (kbd "C-c o b r") 'borg-remove)
  (global-set-key (kbd "C-c o b c") 'borg-clone)
#+end_src
** apheleia
#+begin_src elisp
  (require 'apheleia)
  (add-hook 'prog-mode-hook #'apheleia-mode)
  (add-to-list 'apheleia-mode-alist '(markdown-mode . nil))
  (add-to-list 'apheleia-mode-alist '(org-mode . nil))

  (setf (alist-get 'c-mode apheleia-mode-alist) '(clang-format))
  (setf (alist-get 'c++-mode apheleia-mode-alist) '(clang-format))
  (setf (alist-get 'python-mode apheleia-mode-alist) '(black))
  ;; (setf (alist-get 'go-mode apheleia-mode-alist) '(gofmt))
  ;; (setf (alist-get 'js-mode apheleia-mode-alist) '(prettier))
  ;; (setf (alist-get 'rust-mode apheleia-mode-alist) '(rustfmt))
#+end_src
** amx
#+begin_src elisp
  (require 'amx)
  (add-hook 'after-init-hook 'amx-mode)
#+end_src
** END

#+begin_src emacs-lisp
  (provide 'init-personal)
#+end_src
